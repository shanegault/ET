<!DOCTYPE html>
<html lang="en-NZ">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ET | Emotional Taxonomy</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
  <style>
/* ═══════════════════════════════════════════════════════════
   PHASE 1: CORE STYLES
   ═══════════════════════════════════════════════════════════ */
:root {
  --bg:#0a0a0f; --bg2:#121218; --card:rgba(255,255,255,0.05); --card-h:rgba(255,255,255,0.08);
  --text:#fff; --text2:rgba(255,255,255,0.6); --muted:rgba(255,255,255,0.5); --border:rgba(255,255,255,0.08);
  --em-c:#7B5BBF; --em-l:#9B7BDF; --em-g:rgba(123,91,191,0.4); --em-t:#7B5BBF0d;
  --font-d:'Fraunces',serif; --font-b:'Outfit',sans-serif; --r:20px;
  --screen-transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body{font-family:var(--font-b);background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh;min-height:100dvh;overflow-x:hidden}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit}
textarea,input{font-family:inherit;border:none;background:none;color:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:2px}

/* Focus-visible: keyboard navigation indicator */
button:focus-visible,textarea:focus-visible,input:focus-visible{outline:2px solid rgba(184,157,255,0.8);outline-offset:3px;border-radius:14px}
.sym-pill:focus-visible{border-radius:100px}
.mode-tog:focus-visible{border-radius:100px;outline-offset:2px}
.back-link:focus-visible{border-radius:8px}
.modal-x:focus-visible{border-radius:50%}

/* Reduced motion */
@media(prefers-reduced-motion:reduce){
  .orb{animation:none}
  .screen.active{animation:none}
  .sym-bdy{animation:none}
  .tipp-detail{animation:none}
  .btn-p{transition:none}
  .btn-p.live{transition:none}
  .breathe-circle,.breath-fill{transition:none}
}

@keyframes float{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(30px,-30px) scale(1.1)}66%{transform:translate(-20px,20px) scale(0.9)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:0.6}50%{opacity:1}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes breatheCircle{0%{transform:scale(0.5);opacity:0.6}50%{transform:scale(1);opacity:1}100%{transform:scale(0.5);opacity:0.6}}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes boxTrack{0%{top:-7px;left:-7px}25%{top:-7px;left:calc(100% - 7px)}50%{top:calc(100% - 7px);left:calc(100% - 7px)}75%{top:calc(100% - 7px);left:-7px}100%{top:-7px;left:-7px}}
@keyframes check{from{stroke-dashoffset:20}to{stroke-dashoffset:0}}

.app{position:relative;min-height:100vh;min-height:100dvh}
.orbs{position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:0}
.orb{position:absolute;border-radius:50%;filter:blur(100px);animation:float 25s ease-in-out infinite;transition:all 2s ease-in-out}
.orb-1{width:500px;height:500px;top:-150px;left:-100px;background:linear-gradient(135deg,#FF6B6B,#FF8E53);opacity:0.28;transition:background 1.8s ease-in-out,opacity 1.8s ease-in-out}
.orb-2{width:400px;height:400px;top:40%;right:-100px;background:linear-gradient(135deg,#4ECDC4,#44A3AA);opacity:0.24;animation-delay:-9s;transition:background 1.8s ease-in-out,opacity 1.8s ease-in-out}
.orb-3{width:450px;height:450px;bottom:-100px;left:30%;background:linear-gradient(135deg,#A78BFA,#8B5CF6);opacity:0.26;animation-delay:-17s;transition:background 1.8s ease-in-out,opacity 1.8s ease-in-out}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;position:sticky;top:0;z-index:100;background:rgba(10,10,15,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
.logo{display:flex;align-items:center;gap:12px;cursor:pointer;transition:opacity 0.15s}.logo:hover{opacity:0.8}
.logo svg{width:40px;height:40px;flex-shrink:0}
.logo-txt{display:flex;flex-direction:column}
.logo-t{font-family:var(--font-b);font-size:0.9375rem;font-weight:700;line-height:1.2;letter-spacing:-0.02em}
.logo-s{font-size:0.6875rem;color:var(--muted);font-weight:400;margin-top:1px}
.mode-tog{display:flex;align-items:center;gap:8px;padding:6px 14px;background:var(--card);border-radius:100px;border:1px solid var(--border);font-size:0.75rem;color:var(--text2);transition:all 0.2s;font-weight:500}
.mode-tog:hover{background:var(--card-h)}
.mode-trk{width:36px;height:20px;background:rgba(255,255,255,0.12);border-radius:10px;position:relative;transition:background 0.3s}
.mode-tog.kids .mode-trk{background:linear-gradient(135deg,#9B5DE5,#F15BB5)}
.mode-th{width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);box-shadow:0 2px 4px rgba(0,0,0,0.3)}
.mode-tog.kids .mode-th{transform:translateX(16px)}

/* Screens */
.screen{display:none;min-height:100vh;min-height:100dvh;position:relative;z-index:1}
.screen.active{display:block;animation:fadeIn 0.3s ease-out}
.container{max-width:560px;margin:0 auto;padding:40px 20px 140px}

/* Typography */
.t-xl{font-family:var(--font-d);font-size:clamp(2.25rem,8vw,3rem);font-weight:700;line-height:1.1;letter-spacing:-0.03em}
.t-md{font-family:var(--font-d);font-size:1.25rem;font-weight:600}
.sub{font-size:1rem;color:var(--text2);font-weight:300;line-height:1.5}

/* Symptom Selector */
.sym-sec{border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,0.03);padding:0;margin-top:16px;border-left-width:3px;overflow:hidden}
.sym-sec.body{border-left-color:#FF6B6B;background:rgba(255,107,107,0.04)}
.sym-sec.mind{border-left-color:#4ECDC4;background:rgba(78,205,196,0.04)}
.sym-sec.beh{border-left-color:#A78BFA;background:rgba(167,139,250,0.04)}
.sym-h{display:flex;align-items:center;gap:10px}
.sym-hdr{padding:14px 16px 14px 18px;cursor:pointer;user-select:none;transition:background 0.15s;-webkit-tap-highlight-color:transparent}
.sym-hdr:hover{background:rgba(255,255,255,0.03)}
.sym-hdr:active{background:rgba(255,255,255,0.05)}
.sym-chevron{width:16px;height:16px;flex-shrink:0;color:var(--muted);transition:transform 0.25s ease,color 0.2s;margin-left:4px}
.sym-sec.open .sym-chevron{transform:rotate(180deg)}
.sym-bdy{display:none;padding:12px 16px 16px 18px}
.sym-sec.open .sym-bdy{display:block;animation:fadeUp 0.2s ease-out both}
.sym-icon{width:18px;height:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.sym-icon svg{width:18px;height:18px}
.sym-icon.body svg{color:#FF6B6B}.sym-icon.mind svg{color:#4ECDC4}.sym-icon.beh svg{color:#A78BFA}
.sym-l{font-size:0.75rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase}
.sym-l.body{color:#FF6B6B}.sym-l.mind{color:#4ECDC4}.sym-l.beh{color:#A78BFA}
.sym-count{margin-left:auto;font-size:0.6875rem;font-weight:500;color:var(--muted);letter-spacing:0.03em;margin-right:4px}
.sym-grid{display:flex;flex-wrap:wrap;gap:8px}
.sym-pill{padding:10px 16px;font-size:0.875rem;font-weight:500;border-radius:100px;background:var(--card);color:var(--text2);border:1px solid var(--border);transition:all 0.2s;user-select:none;-webkit-tap-highlight-color:transparent}
.sym-pill:hover{background:var(--card-h);color:var(--text)}
.sym-pill.sel{background:rgba(255,255,255,0.95);color:#0a0a0f;border-color:rgba(255,255,255,0.9);font-weight:600;box-shadow:0 4px 20px rgba(255,255,255,0.15)}

/* Fixed Bottom Bar */
.fix-b{position:fixed;bottom:0;left:0;right:0;padding:24px 20px;background:linear-gradient(to top,var(--bg) 70%,transparent);z-index:50;pointer-events:none}
.fix-b .container{padding:0;pointer-events:auto}
.btn{width:100%;padding:16px;font-size:0.9375rem;font-weight:600;border-radius:14px;transition:all 0.3s;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;letter-spacing:-0.01em}
.btn-main-l{line-height:1.2}
.btn-sub-l{font-size:0.7rem;font-weight:400;opacity:0.65;letter-spacing:0.01em}
.btn-p{background:#fff;color:#0a0a0f;box-shadow:0 8px 30px rgba(255,255,255,0.08)}
.btn-p:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 12px 40px rgba(255,255,255,0.15)}
.btn-p:disabled{background:rgba(255,255,255,0.08);color:var(--muted);box-shadow:none}
.btn-p.live{color:#fff;box-shadow:0 8px 30px var(--em-g);transition:background-image 0.6s ease-in-out,box-shadow 0.6s ease-in-out,opacity 0.4s ease-in-out}
.btn-p.live:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 12px 40px var(--em-g)}
.btn-p.grad-fade{animation:btnGradFade 0.5s ease-in-out}
@keyframes btnGradFade{0%{opacity:0.4}50%{opacity:0.85}100%{opacity:1}}
.btn-s{background:var(--card);color:var(--text2);border:1px solid var(--border)}
.btn-s:hover{background:var(--card-h);color:var(--text)}
.btn-em{background:var(--em-c);color:#fff;box-shadow:0 8px 30px var(--em-g)}
.btn-em:hover{filter:brightness(1.1);transform:translateY(-2px)}

/* Emotion Reveal */
.reveal-wrap{text-align:center;padding-top:32px}
.em-name{font-family:var(--font-d);font-size:clamp(3rem,12vw,4.5rem);font-weight:700;line-height:1;letter-spacing:-0.03em;animation:fadeUp 0.5s ease-out;text-shadow:0 0 60px var(--em-g)}
.em-tag{font-size:1.125rem;color:var(--text2);font-style:italic;margin:12px 0 40px;animation:fadeUp 0.5s ease-out 0.1s both}
.em-why{font-size:0.9375rem;color:var(--text2);max-width:360px;margin:0 auto 40px;line-height:1.6;animation:fadeUp 0.5s ease-out 0.15s both}
.int-opts{display:flex;gap:10px;animation:fadeUp 0.5s ease-out 0.2s both}
.int-btn{flex:1;padding:16px 12px;border-radius:14px;background:var(--card);border:1px solid var(--border);text-align:center;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:4px}
.int-btn:hover{background:var(--card-h)}
.int-btn.sel{background:var(--em-c);border-color:var(--em-l);box-shadow:0 8px 32px var(--em-g);color:#fff}
.int-label{font-weight:600;font-size:0.9375rem}.int-dots{font-size:0.75rem;opacity:0.5}
.back-link{color:var(--muted);font-size:0.8125rem;margin-bottom:16px;display:inline-flex;align-items:center;gap:6px;transition:color 0.15s;font-weight:500}
.back-link:hover{color:var(--text)}

/* Results Page */
.res-header{margin-bottom:28px}
.res-em{font-family:var(--font-d);font-size:clamp(2rem,8vw,2.75rem);font-weight:700;line-height:1.1;letter-spacing:-0.02em}
.res-tag{color:var(--text2);font-size:0.9375rem;margin-top:6px}
.sec-box{background:var(--em-t);border:1px solid var(--border);border-left:3px solid var(--em-c);border-radius:20px;padding:20px;margin-bottom:16px;transition:border-color 1.8s ease-in-out,background 1.8s ease-in-out}
.sec-t{font-family:var(--font-d);font-size:1.1rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:10px}
.sec-icon{font-size:1rem;opacity:0.7}
.cause-l{list-style:none;display:flex;flex-direction:column;gap:8px}
.cause-l li{display:flex;gap:10px;color:var(--text2);font-size:0.875rem;line-height:1.5}
.cause-dot{width:5px;height:5px;border-radius:50%;background:var(--em-c);margin-top:8px;flex-shrink:0}
.tool-list{display:flex;flex-direction:column;gap:8px}
.tool-c{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:14px;text-align:left;transition:all 0.2s;-webkit-tap-highlight-color:transparent}
.tool-c:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.12)}
.tool-c:active{transform:scale(0.98)}
.tool-i{width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.tool-info{flex:1;min-width:0}
.tool-n{font-weight:600;font-size:0.875rem;display:block;margin-bottom:1px}
.tool-d{font-size:0.75rem;color:var(--muted);display:block;line-height:1.4}
.tool-arrow{color:var(--muted);font-size:0.75rem;flex-shrink:0}

/* Modal */
.modal-o{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;opacity:0;transition:opacity 0.3s}
.modal-o.active{display:flex;opacity:1}
.modal{background:#111114;border:1px solid rgba(255,255,255,0.08);border-radius:24px;width:100%;max-width:560px;max-height:92vh;max-height:92dvh;overflow-y:auto;position:relative;animation:slideUp 0.3s ease-out}
.modal-h{padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(17,17,20,0.95);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:10;border-radius:24px 24px 0 0;overflow:hidden}
.modal-x{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-size:0.875rem;transition:background 0.15s}
.modal-x:hover{background:rgba(255,255,255,0.15)}
.modal-b{padding:24px 20px 40px;min-height:300px}

/* Tool Modal Components */
.tool-step{text-align:center;animation:fadeUp 0.3s ease-out}
.tool-title{font-family:var(--font-d);font-size:1.5rem;font-weight:600;margin-bottom:8px}
.tool-sub{color:var(--text2);font-size:0.9375rem;margin-bottom:24px;line-height:1.5}
.tool-prompt{font-family:var(--font-d);font-size:1.25rem;line-height:1.4;margin-bottom:20px;font-weight:600}
.tool-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:14px;padding:14px 16px;color:#fff;font-size:0.9375rem;min-height:80px;resize:none;transition:border-color 0.2s;line-height:1.5}
.tool-input:focus{border-color:var(--em-c)}
.tool-progress{display:flex;gap:6px;justify-content:center;margin-bottom:24px}
.tool-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.12);transition:all 0.3s}
.tool-dot.active{background:var(--em-c);transform:scale(1.2)}
.tool-dot.done{background:rgba(255,255,255,0.4)}
.tool-nav{display:flex;gap:10px;margin-top:24px}
.tool-nav .btn{flex:1}

/* Breathing */
.breath-circle-wrap{position:relative;width:200px;height:200px;margin:32px auto}
.breath-circle{width:100%;height:100%;border-radius:50%;border:2px solid rgba(255,255,255,0.1);position:relative;display:flex;align-items:center;justify-content:center}
.breath-fill{position:absolute;inset:8px;border-radius:50%;background:radial-gradient(circle,var(--em-c),transparent);opacity:0.3;transition:transform 1s ease-in-out,opacity 1s ease-in-out;transform:scale(0.3)}
.breath-fill.expand{transform:scale(1);opacity:0.5}
.breath-text{font-family:var(--font-d);font-size:1.75rem;font-weight:600;z-index:1;transition:opacity 0.3s}
.breath-counter{text-align:center;color:var(--muted);font-size:0.8125rem;margin-top:12px}

/* Box Breathing */
.box-container{width:200px;height:200px;position:relative;margin:32px auto}
.box-border{width:100%;height:100%;border:2px solid rgba(255,255,255,0.1);border-radius:4px;position:relative}
.box-dot{position:absolute;width:14px;height:14px;background:var(--em-c);border-radius:50%;box-shadow:0 0 20px var(--em-c),0 0 6px #fff;top:-7px;left:-7px;opacity:0}
.box-dot.active{opacity:1;animation:boxTrack 16s linear infinite}
.box-side-label{position:absolute;font-size:0.6875rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);font-weight:600}
.box-label-top{top:-22px;left:50%;transform:translateX(-50%)}
.box-label-right{right:-32px;top:50%;transform:translateY(-50%) rotate(90deg)}
.box-label-bottom{bottom:-22px;left:50%;transform:translateX(-50%)}
.box-label-left{left:-32px;top:50%;transform:translateY(-50%) rotate(-90deg)}
.box-center-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-size:1.75rem;font-weight:600}

/* Grounding */
.ground-step{text-align:center;animation:scaleIn 0.3s ease-out}
.ground-num{font-family:var(--font-d);font-size:4rem;font-weight:700;opacity:0.15;line-height:1}
.ground-sense{font-size:1.125rem;font-weight:600;margin:8px 0 4px}
.ground-prompt{color:var(--text2);font-size:0.875rem;margin-bottom:20px}
.ground-items{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.ground-item{padding:10px 18px;border-radius:100px;background:var(--card);border:1px solid var(--border);font-size:0.875rem;color:var(--text2);transition:all 0.2s}
.ground-item.checked{background:var(--em-c);color:#fff;border-color:var(--em-c)}

/* PMR */
.pmr-body{font-size:3rem;text-align:center;margin:16px 0;line-height:1.6}
.pmr-instruction{font-family:var(--font-d);font-size:1.5rem;text-align:center;font-weight:600}
.pmr-timer{font-size:3rem;text-align:center;font-family:var(--font-d);font-weight:700;color:var(--em-c);margin:16px 0}
.pmr-progress{height:4px;background:rgba(255,255,255,0.08);border-radius:2px;margin:20px 0;overflow:hidden}
.pmr-progress-fill{height:100%;background:var(--em-c);border-radius:2px;transition:width 0.3s}

/* TIPP */
.tipp-cards{display:flex;flex-direction:column;gap:10px}
.tipp-card{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:left;transition:all 0.2s}
.tipp-card:hover{background:rgba(255,255,255,0.06)}
.tipp-card.expanded{background:rgba(255,255,255,0.06);border-color:var(--em-c)}
.tipp-header{display:flex;align-items:center;gap:12px}
.tipp-icon{font-size:1.25rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);border-radius:10px;flex-shrink:0}
.tipp-name{font-weight:600;font-size:0.9375rem}
.tipp-detail{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);color:var(--text2);font-size:0.8125rem;line-height:1.6;display:none}
.tipp-card.expanded .tipp-detail{display:block;animation:fadeUp 0.2s ease-out}

/* Reframe Steps */
.reframe-label{font-size:0.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;font-weight:600;margin-bottom:8px}

/* Self-Compassion */
.sc-step{text-align:center;padding:20px 0}
.sc-icon{font-size:2.5rem;margin-bottom:16px}
.sc-phrase{font-family:var(--font-d);font-size:1.375rem;line-height:1.4;margin-bottom:12px;font-weight:600}
.sc-explain{color:var(--text2);font-size:0.875rem;line-height:1.6;max-width:320px;margin:0 auto}

/* Opposite Action */
.oa-card{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:12px;text-align:center}
.oa-label{font-size:0.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;font-weight:600;margin-bottom:8px}
.oa-text{font-family:var(--font-d);font-size:1.25rem;font-weight:600}
.oa-arrow{font-size:1.5rem;color:var(--em-c);margin:8px 0}

/* Completion */
.complete-wrap{text-align:center;padding:40px 0;animation:scaleIn 0.4s ease-out}
.complete-check{width:64px;height:64px;border-radius:50%;background:var(--em-c);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:1.5rem;box-shadow:0 8px 32px var(--em-g)}
.complete-title{font-family:var(--font-d);font-size:1.5rem;font-weight:600;margin-bottom:8px}
.complete-sub{color:var(--text2);font-size:0.9375rem}

/* Reflection */
.reflect-wrap{border-top:1px solid var(--border);margin-top:28px;padding-top:24px;animation:fadeUp 0.35s ease-out both;animation-delay:0.15s}
.reflect-q{font-size:0.875rem;color:var(--text2);margin-bottom:14px;text-align:left}
.reflect-scale{display:flex;gap:8px;justify-content:center;margin-bottom:16px}
.reflect-dot{width:48px;height:48px;border-radius:14px;background:var(--card);border:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;transition:all 0.15s;font-size:1.1rem;flex-shrink:0}
.reflect-dot:hover{background:var(--card-h);border-color:rgba(255,255,255,0.15);transform:translateY(-2px)}
.reflect-dot.sel{background:var(--em-c);border-color:var(--em-c);box-shadow:0 4px 16px var(--em-g)}
.reflect-dot-num{font-size:0.6rem;color:var(--muted);font-family:var(--font-b);font-weight:600;letter-spacing:0.04em}
.reflect-dot.sel .reflect-dot-num{color:rgba(255,255,255,0.8)}
.reflect-note{width:100%;min-height:72px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 14px;font-size:0.875rem;color:var(--text);resize:none;margin-bottom:14px;transition:border-color 0.15s}
.reflect-note:focus{border-color:rgba(255,255,255,0.2);outline:none}
.reflect-actions{display:flex;gap:10px;justify-content:center}
.reflect-skip{font-size:0.8rem;color:var(--muted);background:none;border:none;cursor:pointer;padding:8px 12px;transition:color 0.15s}
.reflect-skip:hover{color:var(--text2)}

@media(max-width:480px){.container{padding:0 16px 140px}.header{padding:12px 16px}}
  </style>
</head>
<body>
<div class="app">
  <div class="orbs" id="orbs"><div class="orb orb-1" id="orb1"></div><div class="orb orb-2" id="orb2"></div><div class="orb orb-3" id="orb3"></div></div>

<!-- ═══════════════════════════════════════════════════════════
     PHASE 2: HTML STRUCTURE
     ═══════════════════════════════════════════════════════════ -->
  <header class="header">
    <div class="logo" onclick="goHome()">
      <svg viewBox="0 0 489.47 501.18" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" d="M244.73,5c3.87,0,7.73,1.88,10.01,5.63l2.89,4.76c10.46,17.19,28.73,26.63,47.41,26.63,10.33,0,20.78-2.88,30.1-8.93l4.67-3.03c2.01-1.3,4.21-1.9,6.35-1.9,5.71,0,11.07,4.23,11.69,10.59l.54,5.54c2.81,28.7,27,50.02,55.08,50.02,2.34,0,4.7-.15,7.08-.45l5.52-.7c.52-.07,1.03-.1,1.53-.1,7.96,0,13.8,8,10.95,15.76l-1.92,5.23c-10.74,29.33,4.87,61.74,34.5,71.63l5.28,1.76c8.33,2.78,10.76,13.4,4.46,19.53l-3.99,3.88c-22.4,21.77-22.4,57.74,0,79.51l3.99,3.88c6.3,6.12,3.88,16.74-4.46,19.53l-5.28,1.76c-29.63,9.89-45.24,42.3-34.5,71.63l1.92,5.23c2.84,7.76-3,15.76-10.95,15.76-.5,0-1.01-.03-1.53-.1l-5.52-.7c-2.38-.3-4.74-.45-7.08-.45-28.08,0-52.27,21.32-55.08,50.02l-.54,5.54c-.62,6.36-5.98,10.59-11.69,10.59-2.14,0-4.34-.6-6.35-1.9l-4.67-3.03c-9.33-6.05-19.78-8.93-30.1-8.93-18.68,0-36.95,9.44-47.41,26.63l-2.89,4.76c-2.28,3.75-6.15,5.63-10.01,5.63s-7.73-1.88-10.01-5.63l-2.89-4.76c-10.46-17.19-28.73-26.63-47.41-26.63-10.33,0-20.78,2.88-30.1,8.93l-4.67,3.03c-2.01,1.3-4.21,1.9-6.35,1.9-5.71,0-11.07-4.23-11.69-10.59l-.54-5.54c-2.81-28.7-27-50.02-55.08-50.02-2.34,0-4.7.15-7.08.45l-5.52.7c-.52.07-1.03.1-1.53.1-7.96,0-13.8-8-10.95-15.76l1.92-5.23c10.74-29.33-4.87-61.74-34.5-71.63l-5.28-1.76c-8.33-2.78-10.76-13.4-4.46-19.53l3.99-3.88c22.4-21.77,22.4-57.74,0-79.51l-3.99-3.88c-6.3-6.12-3.88-16.74,4.46-19.53l5.28-1.76c29.63-9.89,45.24-42.3,34.5-71.63l-1.92-5.23c-2.84-7.76,3-15.76,10.95-15.76.5,0,1.01.03,1.53.1l5.52.7c2.38.3,4.74.45,7.08.45,28.08,0,52.27-21.32,55.08-50.02l.54-5.54c.62-6.36,5.98-10.59,11.69-10.59,2.14,0,4.34.6,6.35,1.9l4.67,3.03c9.33,6.05,19.78,8.93,30.1,8.93,18.68,0,36.95-9.44,47.41-26.63l2.89-4.76c2.28-3.75,6.15-5.63,10.01-5.63M244.73,0c-5.89,0-11.23,3-14.29,8.03l-2.89,4.76c-9.23,15.17-25.35,24.22-43.14,24.22-9.72,0-19.19-2.81-27.38-8.13l-4.67-3.03c-2.73-1.77-5.87-2.71-9.07-2.71-8.66,0-15.83,6.49-16.67,15.1l-.54,5.54c-1.23,12.56-7.07,24.12-16.43,32.55-9.29,8.36-21.25,12.96-33.67,12.96-2.14,0-4.31-.14-6.45-.41l-5.52-.7c-.72-.09-1.45-.14-2.16-.14-5.42,0-10.53,2.68-13.66,7.16-3.17,4.53-3.89,10.12-1.99,15.32l1.92,5.23c4.73,12.91,4.04,26.83-1.92,39.22-5.96,12.38-16.43,21.6-29.47,25.95l-5.28,1.76c-5.58,1.86-9.7,6.4-11.01,12.14-1.31,5.74.43,11.61,4.65,15.71l3.99,3.88c9.86,9.58,15.29,22.42,15.29,36.17s-5.43,26.59-15.29,36.17l-3.99,3.88c-4.22,4.1-5.96,9.98-4.65,15.71,1.31,5.74,5.42,10.28,11.01,12.14l5.28,1.76c13.04,4.35,23.5,13.57,29.47,25.95,5.96,12.38,6.65,26.31,1.92,39.22l-1.91,5.23c-1.91,5.2-1.18,10.78,1.99,15.32,3.13,4.48,8.24,7.16,13.66,7.16.72,0,1.44-.05,2.16-.14l5.52-.7c2.14-.27,4.31-.41,6.45-.41,12.42,0,24.38,4.6,33.67,12.96,9.37,8.43,15.2,19.99,16.44,32.55l.54,5.54c.84,8.61,8.01,15.1,16.67,15.1,3.2,0,6.34-.94,9.07-2.71l4.67-3.03c8.2-5.32,17.67-8.13,27.38-8.13,17.78,0,33.91,9.06,43.14,24.22l2.89,4.76c3.06,5.03,8.4,8.03,14.29,8.03s11.23-3,14.28-8.03l2.89-4.76c9.23-15.17,25.35-24.23,43.14-24.22,9.72,0,19.19,2.81,27.38,8.13l4.67,3.03c2.73,1.77,5.87,2.71,9.07,2.71,8.66,0,15.83-6.49,16.67-15.1l.54-5.54c1.23-12.56,7.07-24.12,16.43-32.55,9.29-8.36,21.25-12.96,33.67-12.96,2.14,0,4.31.14,6.45.41l5.52.7c.72.09,1.45.14,2.16.14,5.42,0,10.53-2.68,13.66-7.16,3.17-4.53,3.89-10.12,1.99-15.32l-1.92-5.23c-4.73-12.91-4.04-26.83,1.92-39.22,5.96-12.38,16.43-21.6,29.47-25.95l5.28-1.76c5.58-1.86,9.7-6.4,11.01-12.14,1.31-5.74-.43-11.61-4.65-15.71l-3.99-3.88c-9.86-9.58-15.29-22.42-15.29-36.17s5.43-26.59,15.29-36.17l3.99-3.88c4.22-4.1,5.96-9.98,4.65-15.71-1.31-5.74-5.42-10.28-11.01-12.14l-5.28-1.76c-13.04-4.35-23.5-13.57-29.47-25.95-5.96-12.38-6.65-26.31-1.92-39.22l1.92-5.23c1.9-5.2,1.18-10.78-1.99-15.32-3.13-4.48-8.24-7.16-13.66-7.16-.72,0-1.45.05-2.16.14l-5.52.7c-2.14.27-4.31.41-6.45.41-12.42,0-24.38-4.6-33.67-12.96-9.37-8.43-15.2-19.99-16.44-32.55l-.54-5.54c-.84-8.61-8.01-15.1-16.67-15.1-3.2,0-6.34.94-9.07,2.71l-4.67,3.03c-8.2,5.32-17.67,8.13-27.38,8.13-17.78,0-33.91-9.06-43.14-24.22l-2.89-4.76c-3.06-5.03-8.4-8.03-14.28-8.03h0Z"/><path fill="#ff0" d="M244.73,250.58L5.3,195.94c.87-3.77,3.56-7.12,7.72-8.51l5.28-1.77c29.63-9.89,45.24-42.3,34.5-71.63l-1.92-5.23c-1.51-4.12-.57-8.32,1.84-11.34l192.01,153.12Z"/><path fill="#79c314" d="M244.73,250.58L5.3,305.23c-.86-3.76.11-7.95,3.26-11.01l4-3.88c22.4-21.77,22.4-57.74,0-79.51l-4-3.88c-3.15-3.06-4.12-7.25-3.26-11.01l239.43,54.64Z"/><path fill="#487de7" d="M244.73,250.58L52.72,403.71c-2.41-3.02-3.35-7.22-1.84-11.34l1.92-5.23c10.74-29.33-4.87-61.74-34.5-71.63l-5.28-1.77c-4.16-1.39-6.85-4.74-7.72-8.51l239.43-54.65Z"/><path fill="#4b369d" d="M244.73,250.58l-106.55,221.27h0c-3.48-1.67-6.14-5.04-6.57-9.41l-.55-5.55c-3.05-31.08-31.17-53.51-62.16-49.57l-5.52.71c-4.36.56-8.24-1.3-10.65-4.32l192.01-153.13Z"/><path fill="#70369d" d="M244.73,250.58v245.59c-3.87,0-7.73-1.88-10.01-5.63l-2.89-4.75c-16.24-26.69-51.31-34.69-77.52-17.7l-4.67,3.04c-3.68,2.39-7.98,2.4-11.46.72l106.55-221.27Z"/><path fill="none" d="M351.29,471.85c-3.48,1.68-7.77,1.67-11.46-.72l-4.68-3.04c-26.2-16.99-61.27-8.99-77.51,17.7l-2.89,4.75c-2.29,3.76-6.16,5.64-10.02,5.63v-245.59l106.56,221.27Z"/><path fill="none" d="M436.74,403.71c-2.41,3.02-6.29,4.87-10.64,4.32l-5.53-.71c-30.98-3.94-59.11,18.49-62.16,49.57l-.54,5.55c-.43,4.37-3.1,7.74-6.58,9.41l-106.56-221.27,192.01,153.13Z"/><path fill="none" d="M484.16,305.23c-.86,3.77-3.55,7.12-7.71,8.51l-5.28,1.77c-29.63,9.89-45.24,42.3-34.5,71.63l1.91,5.23c1.52,4.13.57,8.32-1.84,11.34l-192.01-153.13,239.43,54.65Z"/><path fill="none" d="M480.9,294.22c3.15,3.06,4.12,7.24,3.26,11.01l-239.43-54.65,239.43-54.64c.86,3.77-.11,7.95-3.26,11.01l-3.99,3.88c-22.4,21.77-22.4,57.74,0,79.51l3.99,3.88Z"/><path fill="none" d="M484.16,195.94l-239.43,54.64,192.01-153.12c2.41,3.02,3.36,7.21,1.84,11.34l-1.91,5.23c-10.74,29.33,4.87,61.74,34.5,71.63l5.28,1.77c4.16,1.39,6.85,4.74,7.71,8.51Z"/><path fill="none" d="M436.74,97.46l-192.01,153.12L351.29,29.32c3.48,1.67,6.15,5.04,6.58,9.41l.54,5.55c3.05,31.08,31.18,53.51,62.16,49.57l5.53-.71c4.35-.55,8.23,1.3,10.64,4.32Z"/><path fill="none" d="M351.29,29.32l-106.56,221.26V5c3.86,0,7.73,1.87,10.02,5.63l2.89,4.75c16.24,26.69,51.31,34.69,77.51,17.7l4.68-3.04c3.69-2.39,7.98-2.4,11.46-.72Z"/><path fill="#e91416" d="M244.73,5v245.58L138.18,29.32c3.48-1.68,7.78-1.67,11.46.72l4.67,3.04c26.21,16.99,61.28,8.99,77.52-17.7l2.89-4.75c2.28-3.76,6.14-5.63,10.01-5.63Z"/><path fill="#fea500" d="M244.73,250.58L52.72,97.46c2.41-3.02,6.29-4.88,10.65-4.32l5.52.71c30.99,3.94,59.11-18.49,62.16-49.57l.55-5.55c.43-4.37,3.09-7.74,6.57-9.41h0l106.55,221.26Z"/></svg>
      <div class="logo-txt"><div class="logo-t">Emotional Taxonomy</div><div class="logo-s">Break the feeling down. Build yourself back up.</div></div>
    </div>
    <div class="h-act">
      <button class="mode-tog" id="modeTog"><span class="mode-l" id="modeL">Adult</span><div class="mode-trk"><div class="mode-th"></div></div></button>
    </div>
  </header>

  <!-- SCREEN 1: Symptom Selection -->
  <section class="screen active" id="startScr">
    <div class="container">
      <h1 class="t-xl" id="mainT">What are you experiencing?</h1>
      <p class="sub" id="mainS" style="margin-top:8px">Select everything that resonates.</p>
      <div class="sym-sec body" id="sec-body">
        <div class="sym-h sym-hdr" role="button" tabindex="0" aria-expanded="false" aria-controls="bdy-body" onclick="toggleSymSec('body')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSymSec('body')}">
          <div class="sym-icon body"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M12 9c-2 0-4 1-4 3v2h2l1 5h2l1-5h2v-2c0-2-2-3-4-3z"/></svg></div>
          <span class="sym-l body" id="catBody">Body</span>
          <span class="sym-count" id="cntBody"></span>
          <svg class="sym-chevron" viewBox="0 0 16 16" fill="none"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="sym-bdy" id="bdy-body"><div class="sym-grid" id="bodySym"></div></div>
      </div>
      <div class="sym-sec mind" id="sec-mind">
        <div class="sym-h sym-hdr" role="button" tabindex="0" aria-expanded="false" aria-controls="bdy-mind" onclick="toggleSymSec('mind')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSymSec('mind')}">
          <div class="sym-icon mind"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2a4.5 4.5 0 0 1 4.5 4.5v.5h.5a3.5 3.5 0 0 1 0 7H9a5 5 0 0 1-5-5 5 5 0 0 1 5-5v-.5A4.5 4.5 0 0 1 9.5 2z"/><path d="M14.5 14.5V17a2.5 2.5 0 0 1-5 0v-2.5"/></svg></div>
          <span class="sym-l mind" id="catMind">Mind</span>
          <span class="sym-count" id="cntMind"></span>
          <svg class="sym-chevron" viewBox="0 0 16 16" fill="none"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="sym-bdy" id="bdy-mind"><div class="sym-grid" id="mindSym"></div></div>
      </div>
      <div class="sym-sec beh" id="sec-beh">
        <div class="sym-h sym-hdr" role="button" tabindex="0" aria-expanded="false" aria-controls="bdy-beh" onclick="toggleSymSec('beh')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSymSec('beh')}">
          <div class="sym-icon beh"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
          <span class="sym-l beh" id="catBeh">Actions</span>
          <span class="sym-count" id="cntBeh"></span>
          <svg class="sym-chevron" viewBox="0 0 16 16" fill="none"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="sym-bdy" id="bdy-beh"><div class="sym-grid" id="behSym"></div></div>
      </div>
    </div>
    <div class="fix-b"><div class="container"><button class="btn btn-p" id="contBtn" disabled><span class="btn-main-l" id="contBtnLabel">Identify this feeling</span><span class="btn-sub-l" id="contBtnHint">Pick 3 or more for the best result</span></button></div></div>
  </section>

  <!-- SCREEN 2: Emotion Reveal + Intensity -->
  <section class="screen" id="detScr">
    <div class="container reveal-wrap">
      <button class="back-link" onclick="goHome()">&#8592; Start over</button>
      <h2 class="em-name" id="detEm"></h2>
      <p class="em-tag" id="emTag"></p>
      <p class="em-why" id="emWhy"></p>
      <p class="sub" id="intLabel" style="margin-bottom:12px;font-size:0.875rem">How intense is this?</p>
      <div class="int-opts" id="intOpts">
        <button class="int-btn" onclick="selInt('mild', this)" aria-pressed="false"><span class="int-label" id="int1">Mild</span><span class="int-dots">&#183;</span></button>
        <button class="int-btn" onclick="selInt('moderate', this)" aria-pressed="false"><span class="int-label" id="int2">Moderate</span><span class="int-dots">&#183;&#183;</span></button>
        <button class="int-btn" onclick="selInt('strong', this)" aria-pressed="false"><span class="int-label" id="int3">Strong</span><span class="int-dots">&#183;&#183;&#183;</span></button>
      </div>
    </div>
  </section>

  <!-- SCREEN 3: Results + Tools -->
  <section class="screen" id="resScr">
    <div class="container">
      <button class="back-link" onclick="goHome()">&#8592; Start over</button>
      <div class="res-header">
        <h1 class="res-em" id="resEm"></h1>
        <p class="res-tag" id="resTag"></p>
      </div>
      <div class="sec-box" id="understandBox">
        <h3 class="sec-t"><span class="sec-icon">&#128161;</span> <span id="whyT">Understanding this</span></h3>
        <p id="whyText" style="color:var(--text2);font-size:0.875rem;line-height:1.6;margin-bottom:12px"></p>
        <ul class="cause-l" id="causeL"></ul>
      </div>
      <div class="sec-box">
        <h3 class="sec-t"><span class="sec-icon" id="quickIcon">&#9889;</span> <span id="quickT">Quick Relief</span></h3>
        <div class="tool-list" id="quickL"></div>
      </div>
      <div class="sec-box">
        <h3 class="sec-t"><span class="sec-icon" id="deepIcon">&#127793;</span> <span id="deepT">Deeper Strategies</span></h3>
        <div class="tool-list" id="deepL"></div>
      </div>
      <div style="height:60px"></div>
    </div>
    <div class="fix-b"><div class="container"><button class="btn btn-p" onclick="goHome()" id="newBtn">New Session</button></div></div>
  </section>

  <!-- Tool Modal -->
  <div class="modal-o" id="toolModal" role="dialog" aria-modal="true" aria-labelledby="toolName">
    <div class="modal">
      <div class="modal-h">
        <h3 class="t-md" id="toolName">Tool</h3>
        <button class="modal-x" onclick="closeTool()" aria-label="Close">&#10005;</button>
      </div>
      <div class="modal-b" id="toolContent"></div>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════════════
   BUILD MANIFEST — Use this to resume if session breaks
   ═══════════════════════════════════════════════════════════
   PHASE 1: Core Styles ..................... ✅ Complete
   PHASE 2: HTML Structure ................. ✅ Complete
   PHASE 3: Emotion Database (24 states) ... ✅ Complete
   PHASE 4: Symptom Matrix (52 symptoms) ... ✅ Complete
   PHASE 5: Tool Definitions & Mapping ..... ✅ Complete
   PHASE 6: Scoring Engine & Navigation .... ✅ Complete
   PHASE 7: Interactive Tool Modals (14) ... ✅ Complete
   ═══════════════════════════════════════════════════════════ */

// ═══════════════════════════════════════════════════════════
// PHASE 3: EMOTION DATABASE
// ═══════════════════════════════════════════════════════════
const EMOTIONS = {
  anger: {
    color:'#D62828',
    adult:{ name:'Anger', tag:'A signal that boundaries have been crossed.', why:'Your nervous system is mobilising energy to defend something that matters to you — a value, a need, a boundary. This is one of the most powerful emotions and it exists for a reason.', causes:['Injustice or unfairness','Feeling disrespected','Boundaries being violated','Goals being blocked by others','Accumulated frustration'] },
    kid:{ name:'Mad', tag:'Like a volcano bubbling inside.', why:'Your body fills up with big energy because something feels really unfair or someone crossed your line.', causes:['Someone was mean or unfair','Rules got broken','Nobody is listening','I can\'t do what I want','Someone took my thing'] },
    quickPool:['boxBreathing','pmr','physiologicalSigh','halfSmile','urgeSurf','fiveFingerBreath'],
    deepPool:['oppositeAction','reframe','expressiveWrite','lovingKindness','valuesCompass','thoughtRecord']
  },
  frustration: {
    color:'#E85D04',
    adult:{ name:'Frustration', tag:'Energy with nowhere to go.', why:'You\'re expending effort toward a goal but something keeps blocking progress. The agitation you feel is energy that has accumulated without a release channel.', causes:['Repeated obstacles','Inefficiency or wasted effort','Unmet expectations','Feeling stuck','Communication breakdowns'] },
    kid:{ name:'Stuck', tag:'I keep trying but it won\'t work!', why:'You want to do something SO badly but it\'s just not working and that makes your whole body feel tight and grumpy.', causes:['It\'s too hard','I keep getting it wrong','Waiting too long','Nobody will help me','The rules don\'t make sense'] },
    quickPool:['pmr','boxBreathing','physiologicalSigh','stopPractice','bellyBreath','urgeSurf'],
    deepPool:['reframe','activation','valuesCompass','thoughtRecord','expressiveWrite','pleasantEvents']
  },
  fear: {
    color:'#7B2D8E',
    adult:{ name:'Fear', tag:'Your survival system, activated.', why:'Your brain has detected an immediate threat and triggered the fight-flight-freeze response. Blood flows to your limbs, pupils dilate, and non-essential systems shut down. This kept your ancestors alive.', causes:['Perceived physical danger','Threatening situations','Past trauma being triggered','Loss of safety','Confrontation or conflict'] },
    kid:{ name:'Scared', tag:'I need to be safe right now.', why:'Your body has a super fast alarm system. When it senses danger, it gets you ready to run, fight, or freeze — like a superhero power that keeps you safe.', causes:['Something scary happened','Loud unexpected noises','Being in the dark alone','Scary stories or images','Someone acting threatening'] },
    quickPool:['grounding54321','breathing478','physiologicalSigh','stopPractice','bellyBreath','fiveFingerBreath'],
    deepPool:['oppositeAction','reframe','defusion','safePlace','bodyScan','selfDistancing']
  },
  anxiety: {
    color:'#5A189A',
    adult:{ name:'Anxiety', tag:'The mind racing ahead of reality.', why:'Your threat-detection system is scanning for future dangers. Unlike fear (which responds to present threats), anxiety is your brain running simulations of what could go wrong — a useful function that has gone into overdrive.', causes:['Uncertainty about the future','High-stakes situations','Lack of control','Social evaluation','Information overload'] },
    kid:{ name:'Worry', tag:'My brain keeps asking "what if?"', why:'Your brain is like a really eager guard dog — it\'s trying to protect you by thinking about all the bad things that MIGHT happen. But sometimes it barks at shadows.', causes:['Not knowing what\'s going to happen','A test or performance coming up','Starting something new','Scary thoughts that keep coming back','Too many things to think about'] },
    quickPool:['boxBreathing','grounding54321','physiologicalSigh','stopPractice','urgeSurf','selfDistancing'],
    deepPool:['defusion','reframe','selfCompassion','worryWindow','safePlace','rainPractice']
  },
  sadness: {
    color:'#0077B6',
    adult:{ name:'Sadness', tag:'The weight of what matters.', why:'Sadness slows you down so you can process loss or disappointment. It signals to others that you need support and gives your mind time to adjust to a new reality. It is not weakness — it is recalibration.', causes:['Loss or disappointment','Rejection or exclusion','Failed expectations','Missing someone','Witnessing suffering'] },
    kid:{ name:'Blue', tag:'I feel like a rainy day inside.', why:'When something sad happens, your body slows right down. It\'s like your heart needs a rest so it can heal. Everyone feels blue sometimes.', causes:['Missing someone I love','Losing something special','Being left out','Something didn\'t go how I wanted','A friend moved away'] },
    quickPool:['selfCompassion','activation','bellyBreath','fiveFingerBreath','halfSmile','emotionLabel'],
    deepPool:['oppositeAction','valuesCompass','lovingKindness','expressiveWrite','pleasantEvents','mountainMeditation']
  },
  grief: {
    color:'#023E8A',
    adult:{ name:'Grief', tag:'Love with nowhere to land.', why:'Grief is the natural response to deep loss. It comes in waves — not stages — and encompasses anger, sadness, bargaining, and numbness. It is the price of having loved deeply.', causes:['Death of someone close','End of a significant relationship','Loss of identity or role','Loss of health or ability','Major life transitions'] },
    kid:{ name:'Missing', tag:'My heart hurts because someone is gone.', why:'When someone or something we really love goes away, our heart feels like it has a hole in it. The hurt is big because the love was big.', causes:['Someone I love died','My pet is gone','My parents split up','My best friend left','Things changed and I want them back'] },
    quickPool:['selfCompassion','grounding54321','breathing478','halfSmile','bodyScan','emotionLabel'],
    deepPool:['valuesCompass','savoring','lovingKindness','expressiveWrite','compassionLetter','mountainMeditation']
  },
  shame: {
    color:'#4A4E69',
    adult:{ name:'Shame', tag:'The painful belief of being flawed.', why:'Shame tells you "I am bad" (distinct from guilt\'s "I did bad"). It evolved as a social mechanism to prevent exclusion from the group. But it often fires when it shouldn\'t — amplifying mistakes into identity crises.', causes:['Public failure or humiliation','Feeling exposed or judged','Not meeting your own standards','Childhood conditioning','Social rejection'] },
    kid:{ name:'The Hiding Feeling', tag:'I want to curl up really small.', why:'Sometimes our brain tells us we ARE a mistake instead of that we MADE a mistake. That\'s when you want to hide from everyone. But here\'s the secret: everyone feels this way sometimes.', causes:['I made a mistake in front of people','Someone laughed at me','I feel different from everyone','I broke something important','I feel like I\'m not good enough'] },
    quickPool:['selfCompassion','grounding54321','stopPractice','halfSmile','selfDistancing','emotionLabel'],
    deepPool:['reframe','oppositeAction','valuesCompass','compassionLetter','rainPractice','lovingKindness']
  },
  guilt: {
    color:'#6C584C',
    adult:{ name:'Guilt', tag:'The conscience signalling repair.', why:'Guilt says "I did something bad" — it is about behaviour, not identity. Healthy guilt is a moral compass that motivates repair and changed behaviour. Unhealthy guilt persists long after it has served its purpose.', causes:['Hurting someone you care about','Breaking a personal value','Not meeting responsibilities','Saying something you regret','Inaction when action was needed'] },
    kid:{ name:'Uh-Oh Feeling', tag:'My tummy feels bad about what I did.', why:'The uh-oh feeling is actually really useful! It\'s your conscience — the little voice that helps you know right from wrong. It wants you to make things better.', causes:['I said something mean','I broke a rule on purpose','I didn\'t tell the truth','I forgot something important','I hurt someone\'s feelings'] },
    quickPool:['selfCompassion','breathing478','grounding54321','stopPractice','bellyBreath','emotionLabel'],
    deepPool:['reframe','oppositeAction','valuesCompass','thoughtRecord','expressiveWrite','compassionLetter']
  },
  embarrassment: {
    color:'#E76F51',
    adult:{ name:'Embarrassment', tag:'The spotlight you didn\'t ask for.', why:'Embarrassment is a brief, self-conscious response to an unintentional social violation. Unlike shame, it\'s typically about a specific moment and fades naturally. Your blushing actually signals to others that you recognise the social norm.', causes:['Public mistake or blunder','Unexpected attention','Social faux pas','Being singled out','Physical exposure'] },
    kid:{ name:'Red Face', tag:'I wish I could disappear!', why:'When something awkward happens and everyone sees it, your face goes hot and red. It\'s actually your body\'s way of saying "oops, I know that was silly!" — and that\'s OK.', causes:['I tripped in front of everyone','I said something silly','My body made a weird noise','Teacher called on me and I didn\'t know','Someone saw something private'] },
    quickPool:['grounding54321','selfCompassion','boxBreathing','stopPractice','selfDistancing','halfSmile'],
    deepPool:['reframe','defusion','oppositeAction','rainPractice','thoughtRecord','lovingKindness']
  },
  disgust: {
    color:'#606C38',
    adult:{ name:'Disgust', tag:'The rejection reflex.', why:'Originally evolved to protect you from contaminated food and disease, disgust has expanded to include moral violations and social transgressions. It creates a strong avoidance impulse designed to keep you safe.', causes:['Witnessing moral violations','Contamination or uncleanliness','Violation of personal standards','Toxic behaviour from others','Sensory overwhelm (bad smells, sights)'] },
    kid:{ name:'Yuck', tag:'I want to get away from that!', why:'The yuck feeling started as your body\'s way of keeping you away from things that could make you sick. Now it also happens when something feels really wrong or gross.', causes:['Something smells or looks bad','Someone did something really wrong','Food I don\'t like','Seeing something icky','Someone was cruel to someone else'] },
    quickPool:['grounding54321','boxBreathing','breathing478','bellyBreath','stopPractice','halfSmile'],
    deepPool:['reframe','valuesCompass','oppositeAction','thoughtRecord','selfDistancing','expressiveWrite']
  },
  loneliness: {
    color:'#6C757D',
    adult:{ name:'Loneliness', tag:'A hunger for connection.', why:'Loneliness is a biological alarm that signals unmet social needs — as fundamental as hunger signals unmet nutritional needs. Evolutionarily, isolation from the group meant danger. The pain you feel is your brain urging reconnection.', causes:['Physical isolation','Feeling misunderstood','Lack of deep connection','Social exclusion','Life transitions disrupting community'] },
    kid:{ name:'Lonely', tag:'I wish someone would play with me.', why:'Humans are like pack animals — we need our people! When you feel lonely, your brain is saying "hey, I need a friend right now." That\'s totally normal and nothing to be ashamed of.', causes:['No one to play with','Feeling different from other kids','Missing my family','New school or neighbourhood','Friends are busy without me'] },
    quickPool:['selfCompassion','activation','grounding54321','emotionLabel','bellyBreath','fiveFingerBreath'],
    deepPool:['oppositeAction','valuesCompass','lovingKindness','pleasantEvents','compassionLetter','expressiveWrite']
  },
  overwhelm: {
    color:'#9E2A2B',
    adult:{ name:'Overwhelm', tag:'When demands exceed capacity.', why:'Your cognitive load has exceeded your processing bandwidth. Too many inputs, too many decisions, too many demands — your brain is signalling that it needs to reduce input before it can function effectively again.', causes:['Too many competing priorities','Information overload','Emotional accumulation','Sensory overstimulation','Lack of recovery time'] },
    kid:{ name:'Too Much!', tag:'My bucket is overflowing!', why:'Imagine your brain is a cup. When too many things get poured in at once — homework, noise, feelings, rules — the cup overflows and everything feels impossible.', causes:['Too much homework at once','Everything is loud and busy','Too many feelings at the same time','I don\'t know where to start','Everyone wants something from me'] },
    quickPool:['tipp','boxBreathing','physiologicalSigh','stopPractice','fiveFingerBreath','halfSmile'],
    deepPool:['activation','valuesCompass','defusion','worryWindow','bodyScan','mountainMeditation']
  },
  boredom: {
    color:'#8D99AE',
    adult:{ name:'Boredom', tag:'A signal seeking meaning.', why:'Boredom is not laziness — it\'s a sophisticated signal that your current activity lacks sufficient challenge, novelty, or meaning for your cognitive needs. It\'s actually a motivational state pushing you toward more engaging pursuits.', causes:['Under-stimulation','Lack of purpose or meaning','Repetitive routines','Mismatched skills and challenge','Disconnection from values'] },
    kid:{ name:'Bored', tag:'There\'s NOTHING to do!', why:'When your brain says "I\'m bored," it\'s actually asking for an adventure! It wants something interesting to think about or do. Boredom is your brain\'s way of asking for something better.', causes:['Nothing interesting to do','Same old thing again','Waiting with nothing to play','Lesson is too easy','Friends aren\'t available'] },
    quickPool:['activation','savoring','grounding54321','stopPractice','urgeSurf','emotionLabel'],
    deepPool:['valuesCompass','reframe','pleasantEvents','expressiveWrite','thoughtRecord','mountainMeditation']
  },
  envy: {
    color:'#2D6A4F',
    adult:{ name:'Envy', tag:'Desire wearing someone else\'s face.', why:'Envy reveals what you genuinely value by pointing at what others have that you want. Rather than being purely destructive, it can be informational — showing you your unmet needs and aspirations.', causes:['Others achieving what you want','Social comparison','Perceived unfairness in outcomes','Unmet personal aspirations','Social media exposure'] },
    kid:{ name:'Not Fair Feeling', tag:'How come THEY get that and I don\'t?', why:'When someone has something you really want — a toy, a talent, attention — it can make your tummy twist up. This feeling is trying to tell you what\'s important to you!', causes:['Friend got something cool','Someone is better at something','Sibling got more attention','Not picked for the team','Someone has more friends'] },
    quickPool:['selfCompassion','bellyBreath','breathing478','stopPractice','selfDistancing','emotionLabel'],
    deepPool:['reframe','valuesCompass','gratitude','thoughtRecord','lovingKindness','compassionLetter']
  },
  confusion: {
    color:'#7B6D8D',
    adult:{ name:'Confusion', tag:'The space before understanding.', why:'Confusion means your brain is actively trying to integrate information that doesn\'t fit your current mental models. It\'s actually the precursor to learning — the discomfort of cognitive restructuring in progress.', causes:['Contradictory information','Ambiguous situations','Complex problems','Unexpected outcomes','Mixed signals from others'] },
    kid:{ name:'Mixed Up', tag:'I don\'t get it and my brain feels tangled.', why:'Confusion means your brain is working really hard! It\'s like a puzzle that hasn\'t clicked into place yet. The tangled feeling is actually your brain building new connections.', causes:['Instructions don\'t make sense','Too many new things at once','People say different things','I don\'t understand the rules','Something unexpected happened'] },
    quickPool:['grounding54321','boxBreathing','breathing478','stopPractice','bellyBreath','emotionLabel'],
    deepPool:['reframe','activation','valuesCompass','thoughtRecord','expressiveWrite','selfDistancing']
  },
  surprise: {
    color:'#F77F00',
    adult:{ name:'Surprise', tag:'Reality breaking the script.', why:'Surprise is the briefest emotion — a momentary reset that occurs when reality violates your expectations. It clears your cognitive slate to rapidly process new information. What follows surprise (joy, fear, anger) tells you how you\'ve appraised the unexpected event.', causes:['Unexpected news','Sudden changes in environment','Plans being disrupted','Unanticipated outcomes','Breaking of routine'] },
    kid:{ name:'Whoa!', tag:'I did NOT see that coming!', why:'When something happens that your brain totally didn\'t expect, it does a big "RESET!" — like pressing pause so it can figure out what just happened. Then another feeling usually comes right after.', causes:['A surprise party or gift','Something suddenly changed','A loud unexpected sound','Someone did something I didn\'t expect','I found out something new'] },
    quickPool:['grounding54321','boxBreathing','breathing478','physiologicalSigh','stopPractice','bellyBreath'],
    deepPool:['reframe','savoring','defusion','selfDistancing','bodyScan','emotionLabel']
  },
  joy: {
    color:'#FFD60A',
    adult:{ name:'Joy', tag:'The body saying yes to life.', why:'Joy signals that things are going well — your needs are being met, you\'re making progress, or you\'re experiencing genuine connection. It broadens your thinking, builds psychological resources, and undoes the physical effects of stress.', causes:['Achievement or success','Genuine connection with others','Flow state in meaningful activity','Pleasant surprises','Sensory pleasure or beauty'] },
    kid:{ name:'Happy', tag:'I feel like sunshine inside!', why:'When you feel happy, your body gets light and bouncy, and you want to smile and share it with everyone! Happy feelings are like sunshine — they make everything feel better and brighter.', causes:['Playing with friends','Getting something I wanted','Making someone proud','A fun surprise','Doing something I love'] },
    quickPool:['grounding54321','gratitude','sharing','fiveFingerBreath','emotionLabel','halfSmile'],
    deepPool:['savoring','valuesCompass','lovingKindness','expressiveWrite','mountainMeditation','pleasantEvents']
  },
  excitement: {
    color:'#FF006E',
    adult:{ name:'Excitement', tag:'Anticipation electrified.', why:'Excitement is high-arousal positive anticipation. Your dopamine system is activated in expectation of reward, energising you for action. It shares physiological signatures with anxiety (racing heart, butterflies) but is appraised as pleasurable.', causes:['Upcoming positive events','New opportunities','Creative breakthroughs','Adventure and novelty','Romantic anticipation'] },
    kid:{ name:'Excited', tag:'I CAN\'T WAIT! I CAN\'T WAIT!', why:'That fizzy, bubbly, can\'t-sit-still feeling? That\'s excitement! Your body is getting ready for something AMAZING. It\'s like your insides are doing a happy dance!', causes:['My birthday is coming!','Going on a trip','Meeting someone special','Getting to do something fun','Opening a present'] },
    quickPool:['halfSmile','grounding54321','boxBreathing','bellyBreath','emotionLabel','fiveFingerBreath'],
    deepPool:['savoring','valuesCompass','pleasantEvents','lovingKindness','expressiveWrite','thoughtRecord']
  },
  love: {
    color:'#E63946',
    adult:{ name:'Love', tag:'The deepest form of safety.', why:'Love activates oxytocin and vasopressin pathways that create bonding, trust, and a sense of safety. It\'s the neurobiological foundation of attachment — the signal that this person, this place, this moment is worth protecting and holding close.', causes:['Deep connection with someone','Feeling truly seen and accepted','Caring for someone vulnerable','Moments of intimacy','Witnessing kindness'] },
    kid:{ name:'Loving', tag:'My heart feels big and warm.', why:'Love is the warm, safe, big feeling you get when you\'re with people who matter to you. It\'s like a cozy blanket around your heart. Love makes you want to give hugs and be close.', causes:['Cuddles with family','My pet being sweet','My best friend being kind','Someone taking care of me','Saying I love you'] },
    quickPool:['grounding54321','gratitude','sharing','emotionLabel','halfSmile','fiveFingerBreath'],
    deepPool:['savoring','valuesCompass','lovingKindness','expressiveWrite','compassionLetter','pleasantEvents']
  },
  gratitude: {
    color:'#FCA311',
    adult:{ name:'Gratitude', tag:'Recognising what\'s already here.', why:'Gratitude shifts your attention from what\'s missing to what\'s present. Research consistently shows it strengthens social bonds, improves sleep, reduces inflammation, and builds resilience. It is one of the most reliably beneficial positive emotions.', causes:['Receiving unexpected kindness','Recognising what you have','Surviving a difficulty','Someone going out of their way','Moments of beauty or peace'] },
    kid:{ name:'Thankful', tag:'My heart feels full and warm.', why:'The thankful feeling happens when you notice something good — like a kindness, a gift, or just something nice in your day. It makes your heart feel like it\'s smiling.', causes:['Someone helped me','I got a surprise gift','I noticed something beautiful','Someone was really kind','I have people who love me'] },
    quickPool:['grounding54321','breathing478','sharing','emotionLabel','halfSmile','fiveFingerBreath'],
    deepPool:['gratitude','valuesCompass','savoring','lovingKindness','expressiveWrite','mountainMeditation']
  },
  serenity: {
    color:'#52B788',
    adult:{ name:'Serenity', tag:'The nervous system at rest.', why:'Serenity indicates your parasympathetic nervous system is dominant — the "rest and digest" state. Your body is recovering, your mind is clear, and you feel safe. This is the biological state most conducive to healing, creativity, and genuine connection.', causes:['Being in nature','Feeling safe and settled','After resolving conflict','Meditation or mindfulness','Accepting what is'] },
    kid:{ name:'Calm', tag:'Quiet and easy, like floating on a cloud.', why:'The calm feeling is when everything slows down nice and easy. Your body feels soft, your breathing is slow, and your mind is like a quiet pond. This is your brain\'s favourite resting spot.', causes:['Cuddling up with someone I love','Quiet reading time','Being in nature','Listening to soft music','After a busy day finally resting'] },
    quickPool:['fiveFingerBreath','breathing478','grounding54321','bellyBreath','halfSmile','emotionLabel'],
    deepPool:['savoring','valuesCompass','lovingKindness','mountainMeditation','bodyScan','expressiveWrite']
  },
  hope: {
    color:'#48BFE3',
    adult:{ name:'Hope', tag:'Belief in a way forward.', why:'Hope is not passive wishing — it requires both "pathway thinking" (seeing a route to your goal) and "agency thinking" (believing you can walk that route). Research shows hope is one of the strongest predictors of wellbeing and academic achievement.', causes:['Seeing a possible solution','Receiving encouragement','Small wins after setbacks','Connecting with supportive people','Imagining a better future'] },
    kid:{ name:'Hopeful', tag:'I think something good is coming.', why:'Hope is like a little light in the dark — it helps you keep going even when things are tough. It\'s your brain saying "we can do this, there IS a way!"', causes:['Someone believes in me','I see a way to fix it','Tomorrow might be better','I\'m getting closer to my goal','I made a wish and believe in it'] },
    quickPool:['savoring','gratitude','activation','emotionLabel','bellyBreath','fiveFingerBreath'],
    deepPool:['valuesCompass','pleasantEvents','lovingKindness','expressiveWrite','safePlace','thoughtRecord']
  },
  pride: {
    color:'#9B5DE5',
    adult:{ name:'Pride', tag:'Competence confirmed.', why:'Authentic pride (distinct from hubristic pride) comes from effort-based achievement. It reinforces the behaviours that led to success, motivates continued growth, and contributes to healthy self-esteem. It says: what you did mattered, and you\'re capable.', causes:['Achieving a meaningful goal','Overcoming a challenge','Being recognised for effort','Mastering a new skill','Helping someone successfully'] },
    kid:{ name:'Proud', tag:'I feel like a superhero!', why:'The proud feeling makes you stand tall and feel strong! It comes when you work really hard at something and it pays off. It\'s your brain\'s way of giving you a gold star.', causes:['I did something hard and succeeded','Someone said "great job!"','I learned something new','I helped someone who needed it','I was brave even though I was scared'] },
    quickPool:['grounding54321','sharing','gratitude','emotionLabel','selfDistancing','halfSmile'],
    deepPool:['savoring','valuesCompass','expressiveWrite','lovingKindness','pleasantEvents','compassionLetter']
  },
  amusement: {
    color:'#FB8500',
    adult:{ name:'Amusement', tag:'Tension released through laughter.', why:'Humour requires rapid cognitive reappraisal — seeing incongruity between expectation and reality. Laughter releases endorphins, reduces cortisol, and strengthens social bonds. It\'s one of the fastest ways to shift an emotional state.', causes:['Incongruity and surprise','Playful social interaction','Absurdity in everyday life','Shared jokes and stories','Physical comedy or slapstick'] },
    kid:{ name:'Silly', tag:'I\'ve got the giggles and they won\'t stop!', why:'When something is funny, your brain does a little flip — it expected one thing and got something totally different! That surprise makes you laugh, and laughing feels SO GOOD.', causes:['A really funny joke','Someone making silly faces','Something unexpected and goofy','Tickles and play fighting','A funny video or book'] },
    quickPool:['fiveFingerBreath','sharing','grounding54321','emotionLabel','halfSmile','bellyBreath'],
    deepPool:['savoring','valuesCompass','pleasantEvents','expressiveWrite','mountainMeditation','lovingKindness']
  },
  awe: {
    color:'#3A0CA3',
    adult:{ name:'Awe', tag:'Perceiving something vast.', why:'Awe occurs when you encounter something that exceeds your current mental framework — vastness that requires cognitive accommodation. It reduces self-focus, increases feelings of connectedness, and is associated with reduced inflammatory markers. It literally makes you feel part of something larger.', causes:['Encountering natural grandeur','Extraordinary human achievement','Spiritual or transcendent experiences','Scientific discovery or insight','Art that moves you deeply'] },
    kid:{ name:'Wonder', tag:'My eyes are SO wide and my mouth is open!', why:'The wonder feeling happens when you see something SO BIG or SO AMAZING that your brain can barely fit it in! It makes you feel tiny but in a cool way — like the universe is showing off.', causes:['Looking at the stars','Seeing the ocean or mountains','An incredible magic trick','Learning something mind-blowing','Beautiful music or art'] },
    quickPool:['fiveFingerBreath','grounding54321','breathing478','emotionLabel','halfSmile','bellyBreath'],
    deepPool:['savoring','valuesCompass','lovingKindness','mountainMeditation','expressiveWrite','bodyScan']
  }
};

// ═══════════════════════════════════════════════════════════
// PHASE 4: SYMPTOM MATRIX (52 symptoms)
// ═══════════════════════════════════════════════════════════
const SYMPTOMS = [
  // ── BODY (18) ──
  {id:'racing_heart',cat:'body',a:'Racing heart',k:'Heart going boom-boom-boom',s:{anxiety:3,fear:3,anger:2,excitement:2,surprise:1}},
  {id:'tight_chest',cat:'body',a:'Tight chest',k:'Chest feels squeezy',s:{anxiety:3,fear:2,sadness:2,grief:2,overwhelm:1}},
  {id:'shallow_breath',cat:'body',a:'Shallow breathing',k:'Hard to breathe',s:{anxiety:3,fear:2,overwhelm:2}},
  {id:'fatigue',cat:'body',a:'Fatigue / exhaustion',k:'So so tired',s:{sadness:3,grief:2,overwhelm:2,boredom:1}},
  {id:'tense',cat:'body',a:'Muscle tension',k:'Body feels stiff',s:{anger:3,frustration:3,anxiety:2}},
  {id:'heavy',cat:'body',a:'Heaviness in body',k:'Body feels heavy',s:{sadness:3,grief:3,shame:2,loneliness:1}},
  {id:'hot_face',cat:'body',a:'Flushed face / hot cheeks',k:'Hot red face',s:{embarrassment:3,shame:2,anger:2,excitement:1}},
  {id:'tears',cat:'body',a:'Feeling teary / eyes welling up',k:'Want to cry',s:{sadness:3,grief:3,frustration:2,gratitude:1,joy:1}},
  {id:'warmth',cat:'body',a:'Warmth spreading through body',k:'Warm fuzzy feeling',s:{love:3,joy:2,gratitude:2,serenity:1}},
  {id:'light',cat:'body',a:'Lightness / buoyancy',k:'Bouncy light body',s:{joy:3,excitement:2,hope:2,amusement:2}},
  {id:'goosebumps',cat:'body',a:'Goosebumps / chills',k:'Tingly prickly skin',s:{awe:3,fear:1,excitement:1}},
  {id:'nausea',cat:'body',a:'Nausea / stomach churning',k:'Tummy feels sick',s:{disgust:3,anxiety:2,guilt:2,fear:1}},
  {id:'lump_throat',cat:'body',a:'Lump in throat',k:'Something stuck in my throat',s:{grief:3,sadness:2,guilt:2,gratitude:1}},
  {id:'restless',cat:'body',a:'Fidgety / need to move',k:'Squirmy wiggly feeling',s:{anxiety:2,excitement:2,boredom:2,frustration:2}},
  {id:'clenched',cat:'body',a:'Clenched jaw or fists',k:'Hands in tight fists',s:{anger:3,frustration:2}},
  {id:'butterflies',cat:'body',a:'Butterflies in stomach',k:'Tummy flutters',s:{anxiety:2,excitement:3,love:2}},
  {id:'numb',cat:'body',a:'Numbness / disconnection',k:'Can\'t feel my body',s:{overwhelm:3,grief:2,shame:1}},
  {id:'energy_surge',cat:'body',a:'Surge of energy',k:'So much energy!',s:{anger:2,excitement:3,joy:2,surprise:1}},

  // ── MIND (18) ──
  {id:'looping',cat:'mind',a:'Looping thoughts',k:'Same thought over and over',s:{anxiety:3,guilt:2,shame:2}},
  {id:'catastrophizing',cat:'mind',a:'Imagining the worst / catastrophizing',k:'Thinking the WORST thing',s:{anxiety:3,fear:2}},
  {id:'fog',cat:'mind',a:'Thoughts feel slow / foggy',k:'Brain feels fuzzy and slow',s:{overwhelm:3,confusion:2,sadness:2}},
  {id:'self_critic',cat:'mind',a:'Harsh self-criticism',k:'Being mean to myself',s:{shame:3,guilt:2,sadness:1}},
  {id:'hopeless',cat:'mind',a:'"Nothing will get better" thoughts',k:'It\'ll never get better',s:{sadness:3,grief:2,loneliness:2}},
  {id:'irritable',cat:'mind',a:'Everything feels irritating',k:'Everything is annoying',s:{frustration:3,anger:2,boredom:1}},
  {id:'optimism',cat:'mind',a:'Optimistic thoughts',k:'Good things are coming',s:{hope:3,joy:2,excitement:1}},
  {id:'appreciation',cat:'mind',a:'Noticing what\'s good',k:'Seeing nice things',s:{gratitude:3,serenity:2,awe:1}},
  {id:'curiosity_m',cat:'mind',a:'Curiosity / wonder',k:'I want to know MORE',s:{awe:2,surprise:1,excitement:1,confusion:1}},
  {id:'comparing',cat:'mind',a:'Comparing self to others',k:'They\'re better than me',s:{envy:3,shame:2}},
  {id:'replaying',cat:'mind',a:'Replaying events',k:'Can\'t stop thinking about what happened',s:{guilt:3,embarrassment:2,shame:2}},
  {id:'cant_focus',cat:'mind',a:'Can\'t concentrate',k:'Brain won\'t focus',s:{overwhelm:2,anxiety:2,boredom:2,confusion:1}},
  {id:'injustice',cat:'mind',a:'Sense of injustice',k:'That\'s SO not fair!',s:{anger:3,frustration:2,envy:1}},
  {id:'detached',cat:'mind',a:'Feeling unreal / detached',k:'Everything feels far away or fuzzy',s:{overwhelm:2,fear:1,confusion:2,grief:1}},
  {id:'longing',cat:'mind',a:'Longing for the past',k:'I want things how they were',s:{grief:2,sadness:2,loneliness:1}},
  {id:'connected',cat:'mind',a:'Feeling connected to others',k:'I feel close to people',s:{love:3,gratitude:2,serenity:1}},
  {id:'inspired',cat:'mind',a:'Feeling inspired',k:'I want to create something!',s:{awe:2,hope:2,excitement:2,pride:1}},
  {id:'blank',cat:'mind',a:'Mind suddenly going empty',k:'Brain stopped working',s:{surprise:2,confusion:2,fear:1,overwhelm:1}},

  // ── BEHAVIOUR (16) ──
  {id:'avoid',cat:'beh',a:'Avoiding situations',k:'Don\'t want to go',s:{anxiety:3,shame:2,fear:2,embarrassment:1}},
  {id:'snap',cat:'beh',a:'Snapping at people',k:'Yelling or mean words',s:{anger:3,frustration:2}},
  {id:'withdraw',cat:'beh',a:'Withdrawing / avoiding connection',k:'Want to be alone',s:{sadness:2,shame:2,loneliness:2,grief:2}},
  {id:'checking',cat:'beh',a:'Compulsive checking',k:'Checking things over and over',s:{anxiety:3,guilt:1}},
  {id:'smiling',cat:'beh',a:'Smiling / laughing',k:'Big smiles and giggles',s:{joy:3,amusement:3,love:1,excitement:1}},
  {id:'helping',cat:'beh',a:'Wanting to help others',k:'I want to help!',s:{love:2,gratitude:2,pride:1}},
  {id:'sharing',cat:'beh',a:'Telling others / sharing',k:'I want to show everyone!',s:{pride:2,joy:2,excitement:2}},
  {id:'slowing',cat:'beh',a:'Moving slowly / still',k:'Going really slow',s:{serenity:3,sadness:2,awe:1}},
  {id:'pacing',cat:'beh',a:'Pacing / restless movement',k:'Walking back and forth',s:{anxiety:2,frustration:2,excitement:1}},
  {id:'crying',cat:'beh',a:'Actively crying / sobbing',k:'Tears coming out',s:{sadness:3,grief:3,frustration:1,joy:1,gratitude:1}},
  {id:'hitting',cat:'beh',a:'Urge to hit or throw',k:'Want to smash things',s:{anger:3,frustration:2}},
  {id:'reassurance',cat:'beh',a:'Seeking reassurance',k:'Asking "is it OK?" a lot',s:{anxiety:2,guilt:2,loneliness:1}},
  {id:'zoning',cat:'beh',a:'Zoning out / scrolling',k:'Staring at nothing',s:{boredom:3,overwhelm:2,loneliness:1}},
  {id:'escape',cat:'beh',a:'Wanting to run away',k:'I need to get OUT',s:{fear:3,overwhelm:2,embarrassment:2}},
  {id:'reaching',cat:'beh',a:'Reaching out to people',k:'Wanting to be with someone',s:{loneliness:2,love:2,gratitude:1}},
  {id:'freezing',cat:'beh',a:'Freezing / can\'t move',k:'Stuck like a statue',s:{fear:2,overwhelm:2,surprise:2}}
];

// ═══════════════════════════════════════════════════════════
// PHASE 5: TOOL DEFINITIONS
// ═══════════════════════════════════════════════════════════
const TOOLS = {
  boxBreathing: {
    a:{name:'Box Breathing',desc:'4-4-4-4 pattern to regulate your nervous system',icon:'&#9723;'},
    k:{name:'Square Breathing',desc:'Breathe around the magic square',icon:'&#10024;'},
    type:'quick'
  },
  breathing478: {
    a:{name:'4-7-8 Breathing',desc:'Activates your parasympathetic calming response',icon:'&#127744;'},
    k:{name:'Sleepy Breath',desc:'The breathing trick that melts worries away',icon:'&#127769;'},
    type:'quick'
  },
  grounding54321: {
    a:{name:'5-4-3-2-1 Grounding',desc:'Anchor yourself in the present moment',icon:'&#9875;'},
    k:{name:'Senses Safari',desc:'Go on a hunt with your 5 senses!',icon:'&#128065;'},
    type:'quick'
  },
  pmr: {
    a:{name:'Muscle Release',desc:'Progressive tension and release to let go of physical stress',icon:'&#128170;'},
    k:{name:'Squeeze & Let Go',desc:'Squeeze tight like a robot, then melt like butter!',icon:'&#129302;'},
    type:'quick'
  },
  tipp: {
    a:{name:'TIPP Crisis Reset',desc:'Immediate distress tolerance through physiological hacks',icon:'&#10052;'},
    k:{name:'Emergency Cool-Down',desc:'Super-powered body hacks for BIG feelings',icon:'&#128165;'},
    type:'quick'
  },
  selfCompassion: {
    a:{name:'Self-Compassion Break',desc:'Three steps to treat yourself as you\'d treat a friend',icon:'&#128156;'},
    k:{name:'Be Your Own Best Friend',desc:'Talk to yourself the way your best friend would',icon:'&#129303;'},
    type:'quick'
  },
  savoring: {
    a:{name:'Savoring Practice',desc:'Amplify positive experience with all five senses',icon:'&#127800;'},
    k:{name:'Happiness Magnifier',desc:'Make good feelings BIGGER and LONGER',icon:'&#128526;'},
    type:'deep'
  },
  gratitude: {
    a:{name:'Gratitude Moment',desc:'Shift attention to what\'s already good',icon:'&#128153;'},
    k:{name:'Thank You Heart',desc:'Fill your heart with things you\'re thankful for',icon:'&#128155;'},
    type:'deep'
  },
  sharing: {
    a:{name:'Share the Feeling',desc:'Amplify positive emotions through social connection',icon:'&#128172;'},
    k:{name:'Tell Someone!',desc:'Good feelings get BIGGER when you share them',icon:'&#128227;'},
    type:'quick'
  },
  reframe: {
    a:{name:'Cognitive Reframing',desc:'Challenge thinking patterns by examining the evidence',icon:'&#128269;'},
    k:{name:'Thought Detective',desc:'Put on your detective hat and investigate your thoughts!',icon:'&#128373;'},
    type:'deep'
  },
  oppositeAction: {
    a:{name:'Opposite Action',desc:'Act against the emotional urge when it\'s not serving you',icon:'&#8644;'},
    k:{name:'The Switcheroo',desc:'Do the OPPOSITE of what the feeling wants!',icon:'&#128260;'},
    type:'deep'
  },
  defusion: {
    a:{name:'Thought Defusion',desc:'Create distance between you and your thoughts',icon:'&#127811;'},
    k:{name:'Cloud Watching',desc:'Let your thoughts float by like clouds in the sky',icon:'&#9729;'},
    type:'deep'
  },
  valuesCompass: {
    a:{name:'Values Compass',desc:'Reconnect with what matters most to guide your next step',icon:'&#129517;'},
    k:{name:'What Matters Most',desc:'Find your superpower by remembering what you care about',icon:'&#11088;'},
    type:'deep'
  },
  activation: {
    a:{name:'Tiny Step Forward',desc:'Break the inertia with one small, manageable action',icon:'&#128099;'},
    k:{name:'1-2-3 Go!',desc:'Pick one teeny tiny thing and DO it!',icon:'&#127939;'},
    type:'deep'
  },
  // ── New tools (Phase 1) ──
  physiologicalSigh: {
    a:{name:'Physiological Sigh',desc:'Double inhale + long exhale — fastest breath to reduce arousal',icon:'&#128168;'},
    k:{name:'Double Breath Reset',desc:'Two sniffs in, one long breath out — your body\'s reset button',icon:'&#129316;'},
    type:'quick'
  },
  stopPractice: {
    a:{name:'STOP Practice',desc:'A 60-second mindful pause between stimulus and response',icon:'&#128683;'},
    k:{name:'Traffic Light Stop',desc:'Stop, breathe, look around, then go — like a traffic light',icon:'&#128994;'},
    type:'quick'
  },
  bellyBreath: {
    a:{name:'Belly Breathing',desc:'Diaphragmatic breathing to activate your parasympathetic system',icon:'&#129755;'},
    k:{name:'Balloon Belly',desc:'Make your tummy go out like a balloon when you breathe in',icon:'&#127880;'},
    type:'quick'
  },
  halfSmile: {
    a:{name:'Half-Smile & Willing Hands',desc:'An embodied acceptance posture that reduces emotional reactivity',icon:'&#128528;'},
    k:{name:'Soft Face, Open Hands',desc:'A tiny smile and open palms — your body\'s calm signal',icon:'&#129303;'},
    type:'quick'
  },
  fiveFingerBreath: {
    a:{name:'5-Finger Breathing',desc:'Trace your hand to complete five controlled breath cycles',icon:'&#9995;'},
    k:{name:'Finger Breathing',desc:'Trace your hand — breathe up each finger, breathe down each finger',icon:'&#9995;'},
    type:'quick'
  },
  emotionLabel: {
    a:{name:'Emotion Labelling',desc:'Precise naming reduces amygdala activation — name it to tame it',icon:'&#128204;'},
    k:{name:'Name the Feeling Monster',desc:'Give your feeling a really specific name — it makes it smaller',icon:'&#128123;'},
    type:'quick'
  },
  urgeSurf: {
    a:{name:'Urge Surfing',desc:'Observe an emotional urge like a wave — it peaks and passes without you acting',icon:'&#127940;'},
    k:{name:'Ride the Wave',desc:'Watch the urge like a wave — it gets big, then crashes, all by itself',icon:'&#127960;'},
    type:'quick'
  },
  selfDistancing: {
    a:{name:'Self-Distancing',desc:'Refer to yourself by name to create perspective and reduce emotional flooding',icon:'&#128295;'},
    k:{name:'Be Your Own Friend',desc:'Talk to yourself like you\'d talk to your best friend — use your own name',icon:'&#129309;'},
    type:'quick'
  },
  bodyScan: {
    a:{name:'Body Scan',desc:'Slow, non-judgemental attention through each region of the body',icon:'&#129485;'},
    k:{name:'Head-to-Toe Check-In',desc:'Check in with each part of your body — just notice, no fixing',icon:'&#129335;'},
    type:'deep'
  },
  lovingKindness: {
    a:{name:'Loving-Kindness',desc:'Direct well-wishing phrases outward to build compassion and reduce self-criticism',icon:'&#128149;'},
    k:{name:'Warm Wishes',desc:'Send invisible warm wishes to yourself and the people you love',icon:'&#127925;'},
    type:'deep'
  },
  rainPractice: {
    a:{name:'RAIN Practice',desc:'Recognise, Allow, Investigate, Nurture — a compassionate mindfulness inquiry',icon:'&#127783;'},
    k:{name:'Four-Step Feeling Check',desc:'Notice it, let it be there, look closer, then be kind about it',icon:'&#127752;'},
    type:'deep'
  },
  safePlace: {
    a:{name:'Safe Place Visualisation',desc:'Build a detailed inner sanctuary you can return to when overwhelmed',icon:'&#127968;'},
    k:{name:'My Peaceful Place',desc:'Imagine a place that feels safe and calm — make it as real as you can',icon:'&#129491;'},
    type:'deep'
  },
  compassionLetter: {
    a:{name:'Compassionate Letter',desc:'Write to yourself from a wise, caring friend\'s perspective',icon:'&#128140;'},
    k:{name:'Kind Letter to Me',desc:'Pretend your kindest friend is writing you a letter — what would they say?',icon:'&#128140;'},
    type:'deep'
  },
  expressiveWrite: {
    a:{name:'Expressive Writing',desc:'Unstructured writing about your deepest feelings — for your eyes only',icon:'&#128221;'},
    k:{name:'Feelings Dump',desc:'Write everything you feel — messy, honest, private — no rules',icon:'&#128221;'},
    type:'deep'
  },
  worryWindow: {
    a:{name:'Worry Window',desc:'Contain anxiety to a fixed daily time slot — postpone worry, not suppress it',icon:'&#128337;'},
    k:{name:'Worry Jar',desc:'Put your worries in an imaginary jar — you can take them out later, not now',icon:'&#129514;'},
    type:'deep'
  },
  pleasantEvents: {
    a:{name:'Pleasant Events Scheduling',desc:'Systematically plan small joyful or meaningful activities to lift low mood',icon:'&#128197;'},
    k:{name:'Plan Something Fun',desc:'Pick something you enjoy and actually put it in your plan for this week',icon:'&#127381;'},
    type:'deep'
  },
  thoughtRecord: {
    a:{name:'Thought Record',desc:'Map the ABC of a difficult situation — event, thoughts, feelings, evidence',icon:'&#128203;'},
    k:{name:'Detective Worksheet',desc:'Fill in your detective notebook — what happened, what your brain said, what\'s actually true',icon:'&#128373;'},
    type:'deep'
  },
  mountainMeditation: {
    a:{name:'Mountain Meditation',desc:'Visualise yourself as a mountain — stable through all emotional weather',icon:'&#9968;'},
    k:{name:'Be the Mountain',desc:'You are a big strong mountain — storms and feelings pass, but you stay solid',icon:'&#9968;'},
    type:'deep'
  }
};

// ═══════════════════════════════════════════════════════════
// PHASE 6: SCORING ENGINE & NAVIGATION
// ═══════════════════════════════════════════════════════════
const S = { kids:false, sel:new Set(), emotion:null, intensity:null, timers:[], sessionId:null, currentTool:null };

// ── localStorage helpers ──
function generateSessionId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function getHistory(){ return JSON.parse(localStorage.getItem('et_history') || '[]'); }
function getStats(){ return JSON.parse(localStorage.getItem('et_stats') || '{}'); }

function saveReflection(toolId, rating, note){
  const stats = getStats();
  const emo = S.emotion;
  if(!stats[emo]) stats[emo] = {};
  if(!stats[emo][toolId]) stats[emo][toolId] = { uses:0, totalRating:0, lastUsed:0 };
  stats[emo][toolId].uses++;
  if(rating) stats[emo][toolId].totalRating += rating;
  stats[emo][toolId].lastUsed = Date.now();
  localStorage.setItem('et_stats', JSON.stringify(stats));
  const history = getHistory();
  const session = history.find(s => s.sessionId === S.sessionId);
  const entry = { toolId, rating: rating || null, note: note || '', timestamp: Date.now() };
  if(session){ session.tools.push(entry); }
  else { history.push({ sessionId:S.sessionId, date:new Date().toISOString().slice(0,10), emotion:S.emotion, intensity:S.intensity, tools:[entry] }); }
  if(history.length > 100) history.shift();
  localStorage.setItem('et_history', JSON.stringify(history));
}

function getToolStats(emotion, toolId){
  const stats = getStats();
  return stats[emotion]?.[toolId] || { uses:0, totalRating:0, lastUsed:0 };
}

function getAvgRating(emotion, toolId){
  const s = getToolStats(emotion, toolId);
  return s.uses > 0 ? s.totalRating / s.uses : null;
}

function isFavourite(emotion, toolId){
  const avg = getAvgRating(emotion, toolId);
  const s = getToolStats(emotion, toolId);
  return avg !== null && avg >= 4.0 && s.uses >= 2;
}

function selectToolsForEmotion(emotion){
  const em = EMOTIONS[emotion];
  const stats = getStats()[emotion] || {};
  function rankPool(pool){
    return [...pool].sort((a, b) => {
      const sa = stats[a] || { uses:0, totalRating:0, lastUsed:0 };
      const sb = stats[b] || { uses:0, totalRating:0, lastUsed:0 };
      const avgA = sa.uses > 0 ? sa.totalRating / sa.uses : 2.5;
      const avgB = sb.uses > 0 ? sb.totalRating / sb.uses : 2.5;
      if(Math.abs(avgA - avgB) > 0.5) return avgB - avgA;
      return sa.lastUsed - sb.lastUsed;
    }).slice(0, 3);
  }
  return { quick: rankPool(em.quickPool), deep: rankPool(em.deepPool) };
}

function init(){
  S.kids = false;
  renderSymptoms();
  updateModeUI();
}

function updateModeUI(){
  const tog = document.getElementById('modeTog');
  tog.classList.toggle('kids', S.kids);
  document.getElementById('modeL').innerText = S.kids ? 'Kids' : 'Adult';
  document.getElementById('mainT').innerText = S.kids ? "What's happening right now?" : "What are you experiencing?";
  document.getElementById('mainS').innerText = S.kids ? "Tap everything that feels true." : "Select everything that resonates.";
  document.getElementById('contBtnLabel').innerText = S.kids ? "What is this feeling?" : "Identify this feeling";
  document.getElementById('catBody').innerText = S.kids ? "My Body" : "Body";
  document.getElementById('catMind').innerText = S.kids ? "My Thoughts" : "Mind";
  document.getElementById('catBeh').innerText = S.kids ? "What I'm Doing" : "Actions";
  document.getElementById('int1').innerText = S.kids ? "A little" : "Mild";
  document.getElementById('int2').innerText = S.kids ? "Medium" : "Moderate";
  document.getElementById('int3').innerText = S.kids ? "A LOT" : "Strong";
  document.getElementById('newBtn').innerText = S.kids ? 'Start over' : 'New Session';
  document.getElementById('intLabel').innerText = S.kids ? 'How big is this feeling?' : 'How intense is this?';
}

function renderSymptoms(){
  // Update per-category selected counts and hint
  const catMap = {body:'cntBody', mind:'cntMind', beh:'cntBeh'};
  Object.entries(catMap).forEach(([cat, cntId]) => {
    const total = SYMPTOMS.filter(s=>s.cat===cat).length;
    const sel = SYMPTOMS.filter(s=>s.cat===cat && S.sel.has(s.id)).length;
    const el = document.getElementById(cntId);
    if(el) el.textContent = sel > 0 ? `${sel} of ${total}` : `${total} options`;
  });
  // Update the button hint
  const btnHint = document.getElementById('contBtnHint');
  if(btnHint){
    if(S.sel.size >= 3){
      btnHint.textContent = `${S.sel.size} selected — good to go`;
    } else if(S.sel.size > 0){
      btnHint.textContent = `${S.sel.size} selected — pick a few more for best results`;
    } else {
      btnHint.textContent = S.kids ? 'Pick 3 or more for the best answer' : 'Pick 3 or more for the most accurate result';
    }
  }
  ['body','mind','beh'].forEach(cat => {
    const div = document.getElementById(cat+'Sym');
    div.innerHTML = '';
    SYMPTOMS.filter(s=>s.cat===cat).forEach(s => {
      const btn = document.createElement('button');
      btn.className = 'sym-pill' + (S.sel.has(s.id) ? ' sel' : '');
      btn.innerText = S.kids ? s.k : s.a;
      btn.setAttribute('aria-pressed', S.sel.has(s.id) ? 'true' : 'false');
      btn.onclick = () => toggleSym(s.id);
      div.appendChild(btn);
    });
  });
}

function toggleSymSec(cat){
  const sec = document.getElementById('sec-'+cat);
  const hdr = sec ? sec.querySelector('.sym-hdr') : null;
  if(!sec||!hdr) return;
  const isOpen = sec.classList.toggle('open');
  hdr.setAttribute('aria-expanded', String(isOpen));
}

function toggleSym(id){
  const wasAbsent = !S.sel.has(id);
  S.sel.has(id) ? S.sel.delete(id) : S.sel.add(id);
  // Auto-expand the section when a pill is selected
  if(wasAbsent){
    const sym = SYMPTOMS.find(s=>s.id===id);
    if(sym){
      const sec = document.getElementById('sec-'+sym.cat);
      if(sec && !sec.classList.contains('open')) toggleSymSec(sym.cat);
    }
  }
  document.getElementById('contBtn').disabled = S.sel.size === 0;
  renderSymptoms();
  if(S.sel.size > 0){
    updateOrbs();
    // Pulse: brief opacity bump on selection for "alive" feel
    ['orb1','orb2','orb3'].forEach((oid,i) => {
      const orb = document.getElementById(oid);
      const base = [0.32, 0.28, 0.30][i];
      orb.style.opacity = (base + 0.08).toString();
      setTimeout(()=>{ orb.style.opacity = base.toString(); }, 600);
    });
  } else {
    const btn = document.getElementById('contBtn');
    btn.style.background = '';
    btn.classList.remove('live');
    resetOrbs();
  }
}

function calcScores(){
  const scores = {};
  Object.keys(EMOTIONS).forEach(k => scores[k] = 0);
  S.sel.forEach(sid => {
    const sym = SYMPTOMS.find(s => s.id === sid);
    if(sym) Object.entries(sym.s).forEach(([k,v]) => { if(scores[k]!==undefined) scores[k]+=v; });
  });
  return scores;
}

function updateOrbs(){
  const sc = calcScores();
  const sorted = Object.entries(sc).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length) return;
  const top = sorted[0];
  if(EMOTIONS[top[0]]) setThemeColor(EMOTIONS[top[0]].color);
  // Button: blend top emotions by score share into a gradient or solid
  const total = sorted.reduce((s,[,v])=>s+v, 0);
  const threshold = total * 0.12; // emotions scoring < 12% of total are ignored
  const significant = sorted.filter(([,v])=>v >= threshold).slice(0, 4);
  const btn = document.getElementById('contBtn');
  const wasLive = btn.classList.contains('live');
  if(significant.length === 1){
    // Clear winner — solid colour
    applyBtnGradient(btn, EMOTIONS[significant[0][0]].color, wasLive);
  } else {
    // Multiple emotions — smooth gradient weighted by score share
    // Each colour placed at the midpoint of its score-weighted zone for true blending
    const sigTotal = significant.reduce((s,[,v])=>s+v, 0);
    let pos = 0;
    const stops = [];
    significant.forEach(([k,v]) => {
      const share = (v / sigTotal) * 100;
      const mid = Math.round(pos + share / 2);
      stops.push(`${EMOTIONS[k].color} ${mid}%`);
      pos += share;
    });
    applyBtnGradient(btn, `linear-gradient(135deg, ${stops.join(', ')})`, wasLive);
  }
  btn.classList.add('live');
}

function applyBtnGradient(btn, gradient, animate){
  // Apply new gradient with a brief opacity cross-fade for smooth transition
  btn.style.background = gradient;
  if(animate){
    btn.classList.remove('grad-fade');
    // Force reflow so re-adding the class restarts the animation
    void btn.offsetWidth;
    btn.classList.add('grad-fade');
  }
}

function setThemeColor(c){
  document.documentElement.style.setProperty('--em-c', c);
  document.documentElement.style.setProperty('--em-g', c+'66');
  document.documentElement.style.setProperty('--em-l', c+'cc');
  document.documentElement.style.setProperty('--em-t', c+'0d'); // ~5% alpha — sec-box tint
  // Generate gradient companions: lighter tint and warm/cool shift
  const hsl = hexToHSL(c);
  const h2 = (hsl.h + 30) % 360;  // analogous warm
  const h3 = (hsl.h + 330) % 360; // analogous cool
  const c2 = `hsl(${h2}, ${Math.min(hsl.s+10,100)}%, ${Math.min(hsl.l+15,70)}%)`;
  const c3 = `hsl(${h3}, ${Math.min(hsl.s+5,100)}%, ${Math.min(hsl.l+10,65)}%)`;
  document.getElementById('orb1').style.background = `linear-gradient(135deg, ${c}, ${c2})`;
  document.getElementById('orb1').style.opacity = '0.32';
  document.getElementById('orb2').style.background = `linear-gradient(135deg, ${c2}, ${c3})`;
  document.getElementById('orb2').style.opacity = '0.28';
  document.getElementById('orb3').style.background = `linear-gradient(135deg, ${c3}, ${c})`;
  document.getElementById('orb3').style.opacity = '0.30';
}

function hexToHSL(hex){
  let r=parseInt(hex.slice(1,3),16)/255, g=parseInt(hex.slice(3,5),16)/255, b=parseInt(hex.slice(5,7),16)/255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b), d=max-min;
  let h=0, s=0, l=(max+min)/2;
  if(d>0){ s=l>0.5?d/(2-max-min):d/(max+min); switch(max){case r:h=((g-b)/d+(g<b?6:0))*60;break;case g:h=((b-r)/d+2)*60;break;case b:h=((r-g)/d+4)*60;break;} }
  return {h:Math.round(h),s:Math.round(s*100),l:Math.round(l*100)};
}

function resetOrbs(){
  document.getElementById('orb1').style.background = 'linear-gradient(135deg,#FF6B6B,#FF8E53)';
  document.getElementById('orb1').style.opacity = '0.28';
  document.getElementById('orb2').style.background = 'linear-gradient(135deg,#4ECDC4,#44A3AA)';
  document.getElementById('orb2').style.opacity = '0.24';
  document.getElementById('orb3').style.background = 'linear-gradient(135deg,#A78BFA,#8B5CF6)';
  document.getElementById('orb3').style.opacity = '0.26';
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// Continue button
document.getElementById('contBtn').onclick = () => {
  const sc = calcScores();
  const sorted = Object.entries(sc).sort((a,b)=>b[1]-a[1]);
  S.emotion = sorted[0][0];
  const em = EMOTIONS[S.emotion];
  const txt = S.kids ? em.kid : em.adult;
  
  setThemeColor(em.color);
  document.getElementById('detEm').innerText = txt.name;
  document.getElementById('detEm').style.color = em.color;
  document.getElementById('emTag').innerText = txt.tag;
  document.getElementById('emWhy').innerText = txt.why;
  
  document.querySelectorAll('.int-btn').forEach(b => b.classList.remove('sel'));
  showScreen('detScr');
};

// Mode toggle
document.getElementById('modeTog').onclick = () => {
  S.kids = !S.kids;
  updateModeUI();
  renderSymptoms();
  // Re-render the active screen so language switches everywhere
  if(S.emotion) {
    const em = EMOTIONS[S.emotion];
    const txt = S.kids ? em.kid : em.adult;
    // Detection screen
    const detEm = document.getElementById('detEm');
    if(detEm) { detEm.innerText = txt.name; }
    const emTag = document.getElementById('emTag');
    if(emTag) { emTag.innerText = txt.tag; }
    const emWhy = document.getElementById('emWhy');
    if(emWhy) { emWhy.innerText = txt.why; }
    // Results screen (if visible)
    if(document.getElementById('resScr').classList.contains('active')) {
      showResults();
    }
  }
};

// Intensity selection — receives explicit element reference (avoids event.currentTarget fragility)
window.selInt = (lvl, el) => {
  S.intensity = lvl;
  document.querySelectorAll('.int-btn').forEach(b => {
    b.classList.remove('sel');
    b.setAttribute('aria-pressed', 'false');
  });
  if(el) {
    el.classList.add('sel');
    el.setAttribute('aria-pressed', 'true');
  }
  setTimeout(showResults, 300);
};

function showResults(){
  const em = EMOTIONS[S.emotion];
  const txt = S.kids ? em.kid : em.adult;
  
  document.getElementById('resEm').innerText = txt.name;
  document.getElementById('resEm').style.color = em.color;
  document.getElementById('resTag').innerText = txt.tag;
  document.getElementById('whyT').innerText = S.kids ? "Why this happens" : "Understanding this";
  document.getElementById('whyText').innerText = txt.why;
  document.getElementById('causeL').innerHTML = txt.causes.map(c => 
    `<li><div class="cause-dot"></div><span>${c}</span></li>`
  ).join('');
  
  const positiveEmotions = new Set(['joy','excitement','love','gratitude','serenity','hope','pride','amusement','awe']);
  const isPositive = positiveEmotions.has(S.emotion);
  document.getElementById('quickT').innerText = S.kids
    ? (isPositive ? "Make it last!" : "Feel better fast")
    : (isPositive ? "Keep it going" : "Quick Relief");
  document.getElementById('deepT').innerText = S.kids
    ? (isPositive ? "Grow this feeling" : "Try going deeper")
    : (isPositive ? "Deepen it" : "Deeper Strategies");
  document.getElementById('quickIcon').innerHTML = isPositive ? '&#10024;' : '&#9889;';
  document.getElementById('deepIcon').innerHTML = isPositive ? '&#127807;' : '&#127793;';
  
  // Build tool lists (cycling: ranked by rating then least-recently-used)
  const selected = selectToolsForEmotion(S.emotion);
  const quickTools = selected.quick.map(id => toolCard(id)).join('');
  const deepTools = selected.deep.map(id => toolCard(id)).join('');
  document.getElementById('quickL').innerHTML = quickTools;
  document.getElementById('deepL').innerHTML = deepTools;
  
  showScreen('resScr');
}

function toolCard(toolId){
  const t = TOOLS[toolId];
  const d = S.kids ? t.k : t.a;
  const fav = isFavourite(S.emotion, toolId);
  const st = getToolStats(S.emotion, toolId);
  const isNew = st.uses === 0;
  const badge = fav
    ? `<span style="font-size:0.65rem;color:#FFB84A;margin-left:5px;vertical-align:middle">&#9733;</span>`
    : isNew
    ? `<span style="font-size:0.5625rem;color:rgba(255,255,255,0.9);background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.22);border-radius:100px;padding:2px 7px;margin-left:5px;vertical-align:middle;letter-spacing:0.06em;font-weight:700">NEW</span>`
    : '';
  return `<button class="tool-c" onclick="openTool('${toolId}')">
    <div class="tool-i">${d.icon}</div>
    <div class="tool-info"><span class="tool-n">${d.name}${badge}</span><span class="tool-d">${d.desc}</span></div>
    <span class="tool-arrow">&#8250;</span>
  </button>`;
}

// ═══════════════════════════════════════════════════════════
// PHASE 7: INTERACTIVE TOOL MODALS
// ═══════════════════════════════════════════════════════════
function clearTimers(){ S.timers.forEach(t=>clearInterval(t)); S.timers.forEach(t=>clearTimeout(t)); S.timers=[]; }

// Track last focused element before modal opens, for focus restoration
let _lastFocusedEl = null;

// Escape key closes modal
document.addEventListener('keydown', e => {
  if(e.key === 'Escape' && document.getElementById('toolModal').classList.contains('active')) {
    closeTool();
  }
});

window.openTool = (toolId) => {
  clearTimers();
  S.currentTool = toolId;
  if(!S.sessionId) S.sessionId = generateSessionId();
  _lastFocusedEl = document.activeElement;
  const t = TOOLS[toolId];
  const d = S.kids ? t.k : t.a;
  document.getElementById('toolName').innerText = d.name;
  const c = document.getElementById('toolContent');
  
  const renderers = {
    boxBreathing: renderBoxBreathing,
    breathing478: renderBreathing478,
    grounding54321: renderGrounding,
    pmr: renderPMR,
    tipp: renderTIPP,
    selfCompassion: renderSelfCompassion,
    savoring: renderSavoring,
    gratitude: renderGratitude,
    sharing: renderSharing,
    reframe: renderReframe,
    oppositeAction: renderOppositeAction,
    defusion: renderDefusion,
    valuesCompass: renderValuesCompass,
    activation: renderActivation,
    // New quick tools (Phase 8)
    physiologicalSigh: renderPhysiologicalSigh,
    stopPractice: renderStopPractice,
    bellyBreath: renderBellyBreath,
    halfSmile: renderHalfSmile,
    fiveFingerBreath: renderFiveFingerBreath,
    emotionLabel: renderEmotionLabel,
    urgeSurf: renderUrgeSurf,
    selfDistancing: renderSelfDistancing,
    // New deep tools (Phase 9)
    bodyScan: renderBodyScan,
    lovingKindness: renderLovingKindness,
    rainPractice: renderRainPractice,
    safePlace: renderSafePlace,
    compassionLetter: renderCompassionLetter,
    expressiveWrite: renderExpressiveWrite,
    worryWindow: renderWorryWindow,
    pleasantEvents: renderPleasantEvents,
    thoughtRecord: renderThoughtRecord,
    mountainMeditation: renderMountainMeditation
  };
  
  if(renderers[toolId]) renderers[toolId](c);
  document.getElementById('toolModal').classList.add('active');
  // Move focus to close button for keyboard accessibility
  setTimeout(() => {
    const closeBtn = document.querySelector('.modal-x');
    if(closeBtn) closeBtn.focus();
  }, 50);
};

window.closeTool = () => {
  clearTimers();
  document.getElementById('toolModal').classList.remove('active');
  // Restore focus to the element that triggered the modal
  if(_lastFocusedEl) {
    _lastFocusedEl.focus();
    _lastFocusedEl = null;
  }
};

window.goHome = () => {
  clearTimers();
  S.sel.clear(); S.emotion=null; S.intensity=null; S.sessionId=null; S.currentTool=null;
  const contBtn = document.getElementById('contBtn');
  contBtn.disabled = true;
  contBtn.style.background = '';
  contBtn.classList.remove('live');
  resetOrbs();
  document.documentElement.style.setProperty('--em-c', '#7B5BBF');
  document.documentElement.style.setProperty('--em-g', 'rgba(123,91,191,0.4)');
  document.documentElement.style.setProperty('--em-l', '#9B7BDF');
  document.documentElement.style.setProperty('--em-t', '#7B5BBF0d');
  renderSymptoms();
  updateModeUI();
  showScreen('startScr');
};

// ── TOOL: Box Breathing ──
function renderBoxBreathing(c){
  c.innerHTML = `
    <div class="tool-step">
      <p class="tool-sub">${S.kids ? 'Follow the glowing dot around the square. Breathe with it!' : 'Follow the light. Each side is 4 seconds.'}</p>
      <div class="box-container">
        <div class="box-border">
          <div class="box-dot" id="boxDot"></div>
          <div class="box-center-text" id="boxText">${S.kids ? 'Ready?' : 'Tap to begin'}</div>
        </div>
        <div class="box-side-label box-label-top">${S.kids ? 'Breathe in' : 'Inhale'}</div>
        <div class="box-side-label box-label-right">${S.kids ? 'Wait' : 'Hold'}</div>
        <div class="box-side-label box-label-bottom">${S.kids ? 'Breathe out' : 'Exhale'}</div>
        <div class="box-side-label box-label-left">${S.kids ? 'Wait' : 'Hold'}</div>
      </div>
      <p class="breath-counter" id="boxCounter"></p>
      <button class="btn btn-em" onclick="startBox()" id="boxStartBtn">Start</button>
    </div>`;
}

window.startBox = () => {
  const dot = document.getElementById('boxDot');
  const text = document.getElementById('boxText');
  const counter = document.getElementById('boxCounter');
  const btn = document.getElementById('boxStartBtn');
  if(!dot) return;
  btn.style.display = 'none';
  dot.classList.remove('active'); void dot.offsetWidth; dot.classList.add('active');
  const phases = S.kids ? ['Breathe in...','Hold it...','Breathe out...','Hold it...'] : ['Inhale','Hold','Exhale','Hold'];
  let idx=0, cycles=0;
  text.innerText = phases[0];
  counter.innerText = 'Cycle 1 of 4';
  const timer = setInterval(()=>{
    idx = (idx+1) % 4;
    if(idx===0) cycles++;
    if(cycles>=4){ clearInterval(timer); showComplete(document.getElementById('toolContent'), S.kids ? 'Great breathing!' : 'Well done. Notice how you feel.'); return; }
    text.innerText = phases[idx];
    counter.innerText = `Cycle ${cycles+1} of 4`;
  }, 4000);
  S.timers.push(timer);
};

// ── TOOL: 4-7-8 Breathing ──
function renderBreathing478(c){
  c.innerHTML = `
    <div class="tool-step">
      <p class="tool-sub">${S.kids ? 'This special breath makes your whole body relax. Try it!' : 'Inhale for 4, hold for 7, exhale for 8. One of the most effective calming techniques known.'}</p>
      <div class="breath-circle-wrap">
        <div class="breath-circle">
          <div class="breath-fill" id="breathFill"></div>
          <div class="breath-text" id="breathText">${S.kids ? 'Ready?' : 'Begin'}</div>
        </div>
      </div>
      <p class="breath-counter" id="breathCounter"></p>
      <button class="btn btn-em" onclick="start478()" id="btn478">Start</button>
    </div>`;
}

window.start478 = () => {
  const fill = document.getElementById('breathFill');
  const text = document.getElementById('breathText');
  const counter = document.getElementById('breathCounter');
  document.getElementById('btn478').style.display='none';
  let cycle=0;
  function runCycle(){
    if(cycle>=3){ showComplete(document.getElementById('toolContent'), S.kids ? 'You did it! Feel that calm?' : 'Notice the shift in your nervous system.'); return; }
    counter.innerText = `Breath ${cycle+1} of 3`;
    // Inhale 4s
    fill.classList.add('expand'); text.innerText = S.kids ? 'Breathe in...' : 'Inhale';
    let t1 = setTimeout(()=>{
      text.innerText = S.kids ? 'Hold it...' : 'Hold';
      let t2 = setTimeout(()=>{
        fill.classList.remove('expand'); text.innerText = S.kids ? 'Blow out slow...' : 'Exhale';
        let t3 = setTimeout(()=>{ cycle++; runCycle(); }, 8000);
        S.timers.push(t3);
      }, 7000);
      S.timers.push(t2);
    }, 4000);
    S.timers.push(t1);
  }
  runCycle();
};

// ── TOOL: 5-4-3-2-1 Grounding ──
function renderGrounding(c){
  const steps = S.kids ? [
    {n:5,sense:'SEE',emoji:'&#128064;',prompt:'Tap 5 things you can see right now!'},
    {n:4,sense:'HEAR',emoji:'&#128066;',prompt:'Tap 4 things you can hear!'},
    {n:3,sense:'TOUCH',emoji:'&#9995;',prompt:'Tap 3 things you can feel with your hands!'},
    {n:2,sense:'SMELL',emoji:'&#128067;',prompt:'Tap 2 things you can smell!'},
    {n:1,sense:'TASTE',emoji:'&#128069;',prompt:'Tap 1 thing you can taste!'}
  ] : [
    {n:5,sense:'SEE',emoji:'&#128064;',prompt:'Notice 5 things you can see. Tap each one.'},
    {n:4,sense:'HEAR',emoji:'&#128066;',prompt:'Focus on 4 things you can hear.'},
    {n:3,sense:'TOUCH',emoji:'&#9995;',prompt:'Feel 3 things you can physically touch.'},
    {n:2,sense:'SMELL',emoji:'&#128067;',prompt:'Identify 2 things you can smell.'},
    {n:1,sense:'TASTE',emoji:'&#128069;',prompt:'Notice 1 thing you can taste.'}
  ];
  
  let stepIdx = 0;
  function renderStep(){
    if(stepIdx >= steps.length){ showComplete(c, S.kids ? 'You\'re right here, right now. Safe and sound!' : 'You are here. Present. Grounded.'); return; }
    const s = steps[stepIdx];
    const dots = steps.map((_,i)=>`<div class="tool-dot ${i<stepIdx?'done':''} ${i===stepIdx?'active':''}"></div>`).join('');
    let count = 0;
    const items = Array.from({length:s.n},(_,i)=>`<button class="ground-item" data-gi="${i}">${s.emoji}</button>`).join('');
    c.innerHTML = `<div class="ground-step">
      <div class="tool-progress">${dots}</div>
      <div class="ground-num">${s.n}</div>
      <div class="ground-sense">${s.sense}</div>
      <p class="ground-prompt">${s.prompt}</p>
      <div class="ground-items" id="groundItems">${items}</div>
    </div>`;
    document.querySelectorAll('[data-gi]').forEach(btn=>{
      btn.onclick = function(){
        if(this.classList.contains('checked')) return;
        this.classList.add('checked');
        count++;
        if(count>=s.n){ stepIdx++; setTimeout(renderStep, 400); }
      };
    });
  }
  renderStep();
}

// ── TOOL: PMR (Progressive Muscle Relaxation) ──
function renderPMR(c){
  const groups = S.kids ? [
    {name:'Hands',emoji:'&#9994;',tense:'Squeeze your fists SUPER tight!',release:'Let them go soft like cooked noodles.'},
    {name:'Arms',emoji:'&#128170;',tense:'Make your arms strong like a superhero!',release:'Drop them down, floppy like a ragdoll.'},
    {name:'Shoulders',emoji:'&#129470;',tense:'Push your shoulders up to your ears!',release:'Let them drop down. Ahhhhh.'},
    {name:'Face',emoji:'&#128556;',tense:'Scrunch your face up like you ate a lemon!',release:'Smooth it all out. Big relaxed face.'},
    {name:'Tummy',emoji:'&#129728;',tense:'Make your tummy hard as a rock!',release:'Let it go soft and squishy.'},
    {name:'Legs & Feet',emoji:'&#129462;',tense:'Push your toes down and squeeze your legs!',release:'Let everything go wobbly. Like jelly!'}
  ] : [
    {name:'Hands & Forearms',emoji:'&#9994;',tense:'Clench your fists tightly.',release:'Release. Feel the contrast.'},
    {name:'Biceps & Upper Arms',emoji:'&#128170;',tense:'Flex your arms, curl them up tight.',release:'Let them drop. Notice the heaviness.'},
    {name:'Shoulders & Neck',emoji:'&#129470;',tense:'Raise shoulders to your ears, hold.',release:'Drop them. Let the tension drain.'},
    {name:'Face & Jaw',emoji:'&#128556;',tense:'Scrunch your face, clench your jaw.',release:'Let your face go completely slack.'},
    {name:'Chest & Abdomen',emoji:'&#129728;',tense:'Tighten your core, take a deep breath in.',release:'Exhale fully. Let your torso soften.'},
    {name:'Legs & Feet',emoji:'&#129462;',tense:'Point toes down, tighten calves and thighs.',release:'Release. Feel gravity take over.'}
  ];
  
  let gi = 0;
  function renderGroup(){
    if(gi>=groups.length){ showComplete(c, S.kids ? 'Your whole body is like melted butter now!' : 'Full body release complete. Notice the difference.'); return; }
    const g = groups[gi];
    const pct = Math.round((gi/groups.length)*100);
    c.innerHTML = `<div class="tool-step">
      <div class="pmr-progress"><div class="pmr-progress-fill" style="width:${pct}%"></div></div>
      <div class="pmr-body">${g.emoji}</div>
      <p style="font-weight:600;margin-bottom:4px">${g.name}</p>
      <p class="pmr-instruction" id="pmrInst">${S.kids ? 'Get ready...' : 'Prepare...'}</p>
      <div class="pmr-timer" id="pmrTimer"></div>
      <button class="btn btn-em" onclick="startPMRGroup()" id="pmrBtn">${S.kids ? 'Ready!' : 'Begin'}</button>
    </div>`;
    window.startPMRGroup = () => {
      document.getElementById('pmrBtn').style.display='none';
      const inst = document.getElementById('pmrInst');
      const timer = document.getElementById('pmrTimer');
      inst.innerText = g.tense;
      let sec = 5;
      timer.innerText = sec;
      const iv = setInterval(()=>{
        sec--;
        timer.innerText = sec > 0 ? sec : '';
        if(sec<=0){
          clearInterval(iv);
          inst.innerText = g.release;
          inst.style.color = 'var(--em-c)';
          let rel = 5;
          timer.innerText = rel;
          const iv2 = setInterval(()=>{
            rel--;
            timer.innerText = rel > 0 ? rel : '';
            if(rel<=0){ clearInterval(iv2); gi++; renderGroup(); }
          },1000);
          S.timers.push(iv2);
        }
      },1000);
      S.timers.push(iv);
    };
  }
  renderGroup();
}

// ── TOOL: TIPP ──
function renderTIPP(c){
  const cards = S.kids ? [
    {icon:'&#129482;',name:'Cold Reset',detail:'Splash cold water on your face or hold something cold (like an ice pack wrapped in a cloth) against your cheeks for 30 seconds. This triggers a special reflex that slows your heart right down. It\'s like a restart button for your body!'},
    {icon:'&#127939;',name:'Move Your Body FAST',detail:'Do jumping jacks, run on the spot, or dance wildly for 2 minutes! When you have big feelings, your body fills with energy. Moving fast helps burn that energy off so you can think clearly again.'},
    {icon:'&#127744;',name:'Slow Breathing',detail:'Breathe in while counting to 4, then breathe out while counting to 6. The out-breath being longer is the secret trick — it tells your body "we\'re safe" and switches on your calm system.'},
    {icon:'&#129504;',name:'Squeeze & Breathe',detail:'Pick a muscle (like your fists). Squeeze it tight while breathing in for 5 counts. Then let go while breathing out slowly. Do this 3 times. Your body will start to relax almost like magic!'}
  ] : [
    {icon:'&#129482;',name:'Temperature',detail:'Submerge your face in cold water or apply a cold pack to your cheeks and forehead for 30 seconds. This activates the mammalian dive reflex, rapidly reducing heart rate and redirecting blood flow to the brain. One of the fastest physiological interventions available.'},
    {icon:'&#127939;',name:'Intense Exercise',detail:'Engage in vigorous physical activity for 5-10 minutes — sprinting, burpees, jumping jacks. This metabolises the adrenaline and cortisol flooding your system during high-arousal states, creating a natural physiological reset.'},
    {icon:'&#127744;',name:'Paced Breathing',detail:'Inhale for 4 counts, exhale for 6-8 counts. The extended exhale activates the vagus nerve and engages the parasympathetic nervous system. This is the single most evidence-backed quick intervention for emotional regulation.'},
    {icon:'&#129504;',name:'Paired Muscle Relaxation',detail:'Tense a muscle group while inhaling for 5 seconds, then release completely while exhaling slowly. Repeat for 3-4 muscle groups. This pairs the relaxation response with breathing, compounding the calming effect.'}
  ];
  
  c.innerHTML = `<div class="tool-step">
    <p class="tool-sub">${S.kids ? 'These are body tricks that calm you down FAST. Tap each one to learn how.' : 'Four evidence-based physiological interventions for immediate distress reduction. Tap each to learn more.'}</p>
    <div class="tipp-cards" id="tippCards">
      ${cards.map((card,i) => `
        <button class="tipp-card" onclick="toggleTipp(${i})">
          <div class="tipp-header"><div class="tipp-icon">${card.icon}</div><span class="tipp-name">${card.name}</span></div>
          <div class="tipp-detail">${card.detail}</div>
        </button>`).join('')}
    </div>
  </div>`;
}

window.toggleTipp = (i) => {
  const cards = document.querySelectorAll('.tipp-card');
  cards[i].classList.toggle('expanded');
};

// ── TOOL: Self-Compassion Break ──
function renderSelfCompassion(c){
  const steps = S.kids ? [
    {icon:'&#128557;',phrase:'This is hard right now.',explain:'It\'s OK to say that. You\'re not being weak — you\'re being honest about how you feel.'},
    {icon:'&#127758;',phrase:'Other kids feel this way too.',explain:'You\'re not the only one. All around the world, other kids are having big feelings just like you right now.'},
    {icon:'&#128156;',phrase:'I\'m going to be kind to me.',explain:'Put your hand on your heart. What would your best friend say to you right now? Say that to yourself.'}
  ] : [
    {icon:'&#128557;',phrase:'This is a moment of suffering.',explain:'Acknowledging pain without minimising or dramatising it. Mindfulness is the first step — simply naming what is.'},
    {icon:'&#127758;',phrase:'Suffering is part of being human.',explain:'You are not alone in this. Common humanity recognises that difficulty is a shared experience, not a personal failing.'},
    {icon:'&#128156;',phrase:'May I give myself the compassion I need.',explain:'Place your hand on your chest. What would you say to a close friend in this same situation? Offer those words to yourself.'}
  ];
  
  let si = 0;
  function renderSCStep(){
    if(si>=steps.length){ showComplete(c, S.kids ? 'You were so kind to yourself. That takes real courage.' : 'Self-compassion is not self-indulgence — it is wisdom.'); return; }
    const s = steps[si];
    const dots = steps.map((_,i)=>`<div class="tool-dot ${i<si?'done':''} ${i===si?'active':''}"></div>`).join('');
    c.innerHTML = `<div class="sc-step">
      <div class="tool-progress">${dots}</div>
      <div class="sc-icon">${s.icon}</div>
      <p class="sc-phrase">${s.phrase}</p>
      <p class="sc-explain">${s.explain}</p>
      <button class="btn btn-em" style="margin-top:32px" onclick="nextSC()">${si < steps.length-1 ? (S.kids ? 'Next' : 'Continue') : (S.kids ? 'Done!' : 'Complete')}</button>
    </div>`;
  }
  window.nextSC = () => { si++; renderSCStep(); };
  renderSCStep();
}

// ── TOOL: Savoring ──
function renderSavoring(c){
  const prompts = S.kids ? [
    {sense:'See',emoji:'&#128064;',q:'Look around. What\'s the nicest thing you can see right now?'},
    {sense:'Hear',emoji:'&#128066;',q:'Close your eyes. What\'s a nice sound you can hear?'},
    {sense:'Feel',emoji:'&#9995;',q:'Touch something nearby. What does it feel like?'},
    {sense:'Breathe',emoji:'&#128067;',q:'Take a big sniff. Can you smell anything nice?'},
    {sense:'Remember',emoji:'&#128156;',q:'Think of your favourite happy moment. Hold onto it!'}
  ] : [
    {sense:'Sight',emoji:'&#128064;',q:'What is the most pleasing thing in your visual field right now? Study it. Notice colours, light, texture.'},
    {sense:'Sound',emoji:'&#128066;',q:'Close your eyes. Isolate one pleasant or interesting sound. Let it fill your attention.'},
    {sense:'Touch',emoji:'&#9995;',q:'Notice the physical sensations where your body meets the world. Temperature, texture, pressure.'},
    {sense:'Scent',emoji:'&#128067;',q:'Breathe deeply. Is there a scent you can notice? Even subtle — fresh air, coffee, rain?'},
    {sense:'Amplify',emoji:'&#128156;',q:'Hold this positive moment. Imagine it spreading warmth through your chest. You are allowed to feel good.'}
  ];
  
  let pi = 0;
  function renderSavStep(){
    if(pi>=prompts.length){ showComplete(c, S.kids ? 'You made that good feeling even BIGGER!' : 'Savoring amplifies positive neurochemistry. The more you practice, the more natural it becomes.'); return; }
    const p = prompts[pi];
    const dots = prompts.map((_,i)=>`<div class="tool-dot ${i<pi?'done':''} ${i===pi?'active':''}"></div>`).join('');
    c.innerHTML = `<div class="tool-step">
      <div class="tool-progress">${dots}</div>
      <p style="font-size:2.5rem;margin-bottom:8px">${p.emoji}</p>
      <p style="font-weight:600;margin-bottom:4px;font-size:0.8125rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted)">${p.sense}</p>
      <p class="tool-prompt">${p.q}</p>
      <p style="color:var(--muted);font-size:0.8125rem;margin-bottom:20px">${S.kids ? 'Take your time. Then tap next.' : 'Sit with this for 15-20 seconds.'}</p>
      <button class="btn btn-em" onclick="nextSav()">${pi < prompts.length-1 ? 'Next' : (S.kids ? 'Done!' : 'Complete')}</button>
    </div>`;
  }
  window.nextSav = () => { pi++; renderSavStep(); };
  renderSavStep();
}

// ── TOOL: Gratitude Moment ──
function renderGratitude(c){
  c.innerHTML = `<div class="tool-step">
    <p style="font-size:2.5rem;margin-bottom:12px">&#128156;</p>
    <p class="tool-prompt">${S.kids ? 'Name 3 things that make you smile!' : 'Name three things you\'re genuinely grateful for right now.'}</p>
    <p class="tool-sub">${S.kids ? 'They can be big or tiny!' : 'They don\'t need to be significant. Small, specific things work best.'}</p>
    <div style="display:flex;flex-direction:column;gap:10px;width:100%;margin-bottom:24px">
      <input type="text" class="tool-input" style="min-height:auto;padding:12px 16px" placeholder="${S.kids ? '1. Something that made me happy...' : '1. I\'m grateful for...'}" id="g1">
      <input type="text" class="tool-input" style="min-height:auto;padding:12px 16px" placeholder="${S.kids ? '2. Someone I appreciate...' : '2. I appreciate...'}" id="g2">
      <input type="text" class="tool-input" style="min-height:auto;padding:12px 16px" placeholder="${S.kids ? '3. Something nice today...' : '3. I\'m thankful for...'}" id="g3">
    </div>
    <button class="btn btn-em" onclick="submitGratitude()">Done</button>
  </div>`;
}

window.submitGratitude = () => {
  const c = document.getElementById('toolContent');
  showComplete(c, S.kids ? 'Your heart is full of good things!' : 'Gratitude rewires attention toward what sustains you. This shift compounds over time.');
};

// ── TOOL: Sharing ──
function renderSharing(c){
  c.innerHTML = `<div class="tool-step">
    <p style="font-size:2.5rem;margin-bottom:12px">&#128172;</p>
    <p class="tool-prompt">${S.kids ? 'Good feelings get BIGGER when you share them!' : 'Positive emotions are amplified through social sharing.'}</p>
    <p class="tool-sub" style="text-align:left">${S.kids ? 
      'Here are some ideas:<br><br>&#127775; Tell someone about your good feeling<br>&#127775; Draw a picture about it<br>&#127775; Do a happy dance with someone<br>&#127775; Write it in a journal or diary<br>&#127775; Call someone you love' : 
      'Research shows that sharing positive experiences — called "capitalisation" — strengthens both the emotion and the relationship.<br><br>Consider:<br><br>&#8226; Text or call someone about what happened<br>&#8226; Write it down to revisit later<br>&#8226; Share with someone who will celebrate with you<br>&#8226; Record a voice memo to capture how you feel<br>&#8226; Express it creatively — write, draw, compose'}</p>
    <button class="btn btn-em" style="margin-top:16px" onclick="closeTool()">Got it</button>
  </div>`;
}

// ── TOOL: Cognitive Reframing ──
function renderReframe(c){
  const steps = S.kids ? [
    {label:'What happened?',prompt:'Tell me what happened — like you\'re telling a story.',placeholder:'Something happened and I felt...'},
    {label:'What\'s your brain saying?',prompt:'What is the thought that keeps popping up?',placeholder:'My brain keeps saying...'},
    {label:'Detective time!',prompt:'Is there any proof this thought is 100% true? What would your best friend say?',placeholder:'Well, actually...'},
    {label:'New thought!',prompt:'What\'s a kinder, fairer way to think about this?',placeholder:'Maybe what\'s really true is...'}
  ] : [
    {label:'Situation',prompt:'Describe the situation factually. What happened?',placeholder:'What actually occurred, without interpretation...'},
    {label:'Automatic thought',prompt:'What thought fired automatically? What did your mind tell you this means?',placeholder:'The thought that came up was...'},
    {label:'Evidence check',prompt:'What evidence supports this thought? What evidence challenges it? What would you tell a friend?',placeholder:'The evidence for this thought is... But against it...'},
    {label:'Balanced perspective',prompt:'What is a more balanced, accurate way to view this situation?',placeholder:'A more balanced perspective would be...'}
  ];
  
  let ri=0; const answers=[];
  function renderRStep(){
    if(ri>=steps.length){
      showComplete(c, S.kids ? 'Great detective work! You found a better thought.' : 'Cognitive restructuring weakens distorted thought patterns through evidence-based challenge. Practice builds automatic reappraisal.');
      return;
    }
    const s = steps[ri];
    const dots = steps.map((_,i)=>`<div class="tool-dot ${i<ri?'done':''} ${i===ri?'active':''}"></div>`).join('');
    c.innerHTML = `<div class="tool-step" style="text-align:left">
      <div class="tool-progress">${dots}</div>
      <p class="reframe-label">${S.kids ? `Step ${ri+1}` : `Step ${ri+1} of 4`}</p>
      <p class="tool-prompt">${s.prompt}</p>
      <textarea class="tool-input" placeholder="${s.placeholder}" id="rfInput">${answers[ri]||''}</textarea>
      <div class="tool-nav">
        ${ri>0 ? `<button class="btn btn-s" onclick="prevRF()">Back</button>` : ''}
        <button class="btn btn-em" onclick="nextRF()">${ri<steps.length-1 ? 'Next' : (S.kids ? 'Done!' : 'Complete')}</button>
      </div>
    </div>`;
  }
  window.nextRF = () => { answers[ri]=document.getElementById('rfInput').value; ri++; renderRStep(); };
  window.prevRF = () => { answers[ri]=document.getElementById('rfInput').value; ri--; renderRStep(); };
  renderRStep();
}

// ── TOOL: Opposite Action ──
function renderOppositeAction(c){
  const em = EMOTIONS[S.emotion];
  const urges = {
    anger:{urge:'attack, raise your voice, or confront',opposite:'speak gently, take space, or do something kind',kidUrge:'yell, hit, or say mean things',kidOpp:'use a quiet voice, walk away calmly, or do something gentle'},
    frustration:{urge:'force the issue or give up entirely',opposite:'take a break, try a different approach, or ask for help',kidUrge:'throw things or quit',kidOpp:'take a break, try it a different way, or ask for help'},
    fear:{urge:'avoid, escape, or freeze',opposite:'approach the situation gradually and stay present',kidUrge:'run away or hide',kidOpp:'take one tiny brave step closer'},
    anxiety:{urge:'avoid, seek reassurance, or control',opposite:'approach what you\'re avoiding, tolerate uncertainty',kidUrge:'not go, ask "is it OK?" over and over, or worry more',kidOpp:'try the thing anyway, tell yourself "I can handle this"'},
    sadness:{urge:'withdraw, isolate, or go inactive',opposite:'reach out, move your body, or engage in something meaningful',kidUrge:'stay in bed, be alone, or stop doing fun things',kidOpp:'call a friend, go outside, or do something you usually enjoy'},
    grief:{urge:'isolate and shut down',opposite:'gently connect with someone who understands, and allow the waves',kidUrge:'hide and be alone with the hurt',kidOpp:'let someone sit with you, even quietly'},
    shame:{urge:'hide, withdraw, or attack yourself',opposite:'share your experience with someone safe, act with integrity',kidUrge:'hide away and keep it secret',kidOpp:'tell someone you trust — they won\'t think less of you'},
    guilt:{urge:'punish yourself or avoid the person',opposite:'make amends or accept what can\'t be changed',kidUrge:'feel bad forever or hide from the person',kidOpp:'say sorry and try to make it right'},
    embarrassment:{urge:'disappear or replay the moment',opposite:'stay present, maybe even laugh about it',kidUrge:'wish you could vanish',kidOpp:'laugh it off — everyone has silly moments!'},
    disgust:{urge:'avoid and reject',opposite:'approach with curiosity or tolerance',kidUrge:'push it away and say YUCK',kidOpp:'take a breath and look again more calmly'},
    loneliness:{urge:'withdraw further or believe no one cares',opposite:'reach out, initiate contact, or go where people are',kidUrge:'think nobody likes you and stay alone',kidOpp:'ask someone to play, or tell a grown-up how you feel'},
    overwhelm:{urge:'shut down or try to do everything at once',opposite:'do one single small thing, then rest',kidUrge:'freeze up or cry because it\'s too much',kidOpp:'pick just ONE thing. Only one. That\'s enough.'},
    envy:{urge:'compare and criticise yourself or others',opposite:'celebrate their success and identify your own values',kidUrge:'say "it\'s not fair" and feel bad',kidOpp:'think about what YOU\'re good at and what makes you special'}
  };
  
  const u = urges[S.emotion] || urges.anxiety;
  c.innerHTML = `<div class="tool-step">
    <p class="tool-sub">${S.kids ? 'When a feeling wants you to do one thing, sometimes doing the OPPOSITE helps!' : 'When an emotion\'s action urge is unhelpful, deliberately acting opposite can shift the entire emotional experience.'}</p>
    <div class="oa-card">
      <p class="oa-label">${S.kids ? 'The feeling wants you to...' : 'The urge'}</p>
      <p class="oa-text" style="color:${em.color}">${S.kids ? u.kidUrge : u.urge}</p>
    </div>
    <div class="oa-arrow">&#8595;</div>
    <div class="oa-card" style="border-color:var(--em-c)">
      <p class="oa-label">${S.kids ? 'Try the switcheroo!' : 'The opposite action'}</p>
      <p class="oa-text">${S.kids ? u.kidOpp : u.opposite}</p>
    </div>
    <p style="color:var(--muted);font-size:0.8125rem;margin-top:16px;line-height:1.5">${S.kids ? 'You don\'t have to do it perfectly. Even a tiny switcheroo counts!' : 'Commit to the opposite action fully — body language, tone, and behaviour. Half-measures are less effective.'}</p>
    <button class="btn btn-em" style="margin-top:20px" onclick="closeTool()">${S.kids ? 'I\'ll try it!' : 'Got it'}</button>
  </div>`;
}

// ── TOOL: Thought Defusion ──
function renderDefusion(c){
  c.innerHTML = `<div class="tool-step">
    <p style="font-size:2.5rem;margin-bottom:12px">${S.kids ? '&#9729;' : '&#127811;'}</p>
    <p class="tool-prompt">${S.kids ? 'What thought keeps bugging you?' : 'What is the difficult thought?'}</p>
    <p class="tool-sub">${S.kids ? 'Type it out below — we\'re going to put it on a cloud.' : 'Write the thought that\'s hooked you. We\'ll create some distance from it.'}</p>
    <textarea class="tool-input" placeholder="${S.kids ? 'The thought that won\'t go away is...' : 'The thought I\'m fused with is...'}" id="defInput" style="margin-bottom:20px"></textarea>
    <button class="btn btn-em" onclick="defuse()">Transform it</button>
  </div>`;
}

window.defuse = () => {
  const thought = document.getElementById('defInput').value || (S.kids ? "I'm not good enough" : "I'm not good enough");
  const c = document.getElementById('toolContent');
  c.innerHTML = `<div class="tool-step" style="animation:fadeUp 0.4s ease-out">
    <p style="font-size:2.5rem;margin-bottom:16px">${S.kids ? '&#9729;' : '&#127811;'}</p>
    <p style="color:var(--muted);font-size:0.8125rem;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px">${S.kids ? 'The old way' : 'Fused'}</p>
    <p style="font-family:var(--font-d);font-size:1.25rem;margin-bottom:24px;opacity:0.5;text-decoration:line-through">${thought}</p>
    <p style="color:var(--em-c);font-size:0.8125rem;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px">${S.kids ? 'The cloud way' : 'Defused'}</p>
    <p style="font-family:var(--font-d);font-size:1.25rem;margin-bottom:12px">${S.kids ? `I notice my brain is saying "${thought}"` : `I\'m having the thought that "${thought}"`}</p>
    <p style="color:var(--text2);font-size:0.875rem;line-height:1.6;margin-bottom:24px;max-width:360px;margin-left:auto;margin-right:auto">${S.kids ? 
      'See? The thought is still there, but now YOU\'RE the one watching it — like watching a cloud float by. You\'re the whole big sky. The thought is just one little cloud.' : 
      'The thought hasn\'t changed. But your relationship to it has. You are the observer, not the thought. Thoughts are mental events — not facts, not commands, not you.'}</p>
    <button class="btn btn-em" onclick="closeTool()">${S.kids ? 'I am the sky!' : 'I understand'}</button>
  </div>`;
};

// ── TOOL: Values Compass ──
function renderValuesCompass(c){
  const values = S.kids ? [
    {emoji:'&#128106;',name:'Family & Friends',q:'Who do I love the most?'},
    {emoji:'&#127891;',name:'Learning',q:'What do I want to get better at?'},
    {emoji:'&#127918;',name:'Fun & Play',q:'What makes me laugh and smile?'},
    {emoji:'&#128170;',name:'Being Brave',q:'When was I brave and it felt good?'},
    {emoji:'&#128156;',name:'Being Kind',q:'How can I help someone today?'},
    {emoji:'&#127912;',name:'Creating',q:'What do I love to make or build?'}
  ] : [
    {emoji:'&#128106;',name:'Connection',q:'Who matters most? Are you nurturing those relationships?'},
    {emoji:'&#127793;',name:'Growth',q:'What are you learning or developing? Does your current path support it?'},
    {emoji:'&#127775;',name:'Purpose',q:'What gives your life meaning? Are you moving toward or away from it?'},
    {emoji:'&#129504;',name:'Health',q:'Are you caring for your body and mind? What does that look like today?'},
    {emoji:'&#127912;',name:'Creativity',q:'Are you making space for expression and imagination?'},
    {emoji:'&#128170;',name:'Courage',q:'What would you do if you weren\'t afraid? Can you take one step toward it?'}
  ];
  
  let vi = 0;
  function renderVStep(){
    if(vi>=values.length){ showComplete(c, S.kids ? 'Now you know what matters most to you. That\'s your superpower!' : 'Values don\'t eliminate pain — they give direction through it. One value-aligned step today is enough.'); return; }
    const v = values[vi];
    const dots = values.map((_,i)=>`<div class="tool-dot ${i<vi?'done':''} ${i===vi?'active':''}"></div>`).join('');
    c.innerHTML = `<div class="tool-step">
      <div class="tool-progress">${dots}</div>
      <p style="font-size:2.5rem;margin-bottom:8px">${v.emoji}</p>
      <p style="font-weight:600;margin-bottom:4px">${v.name}</p>
      <p class="tool-prompt">${v.q}</p>
      <div class="tool-nav">
        <button class="btn btn-s" onclick="skipV()">Skip</button>
        <button class="btn btn-em" onclick="nextV()">${S.kids ? 'This one!' : 'This resonates'}</button>
      </div>
    </div>`;
  }
  window.nextV = () => {
    const c2 = document.getElementById('toolContent');
    showComplete(c2, S.kids ? `${values[vi].name} is your compass today! What\'s one thing you can do for it?` : `"${values[vi].name}" — let this guide your next decision. What is one small, value-aligned action you can take today?`);
  };
  window.skipV = () => { vi++; renderVStep(); };
  renderVStep();
}

// ── TOOL: Tiny Step / Activation ──
function renderActivation(c){
  const suggestions = S.kids ? [
    'Stand up and stretch for 10 seconds',
    'Drink a glass of water',
    'Draw a quick picture',
    'Walk to the window and look outside',
    'Tidy one small thing',
    'Do 5 jumping jacks'
  ] : [
    'Stand up and move for 60 seconds',
    'Send one text message to someone',
    'Drink a full glass of water',
    'Step outside for 2 minutes of fresh air',
    'Write one sentence about how you feel',
    'Complete one small task you\'ve been avoiding',
    'Tidy one visible surface',
    'Open the blinds or curtains'
  ];
  
  c.innerHTML = `<div class="tool-step">
    <p style="font-size:2.5rem;margin-bottom:12px">${S.kids ? '&#127939;' : '&#128099;'}</p>
    <p class="tool-prompt">${S.kids ? 'Pick ONE tiny thing and do it right now!' : 'Inertia breaks with a single movement. Pick one tiny step.'}</p>
    <p class="tool-sub">${S.kids ? 'Here are some ideas — or make up your own!' : 'The goal isn\'t productivity. It\'s momentum. Completion triggers dopamine, which fuels the next step.'}</p>
    <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:24px">
      ${suggestions.map(s => `<button class="ground-item" onclick="this.classList.toggle('checked')">${s}</button>`).join('')}
    </div>
    <button class="btn btn-em" onclick="completeActivation()">I did one!</button>
  </div>`;
}

window.completeActivation = () => {
  showComplete(document.getElementById('toolContent'), S.kids ? 'You did it! That tiny step just proved you CAN do things, even when it\'s hard!' : 'One step taken. That\'s enough. Momentum is not about speed — it\'s about direction.');
};

// ═══════════════════════════════════════════════════════════
// PHASE 8: NEW QUICK TOOL RENDERERS
// ═══════════════════════════════════════════════════════════

// ── Physiological Sigh ──
function renderPhysiologicalSigh(c){
  let round = 0; const total = 3;
  const phases = S.kids
    ? ['Sniff in...','Sniff again!','Breathe out slowly...']
    : ['First inhale...','Second inhale...','Long exhale...'];
  const durations = [1500, 1000, 5000];
  let phaseIdx = 0;
  function nextPhase(){
    if(phaseIdx >= 3){ phaseIdx=0; round++; if(round>=total){ showComplete(c, S.kids ? 'Your body\'s reset button — use it anytime!' : 'That\'s the fastest breath-based reset your nervous system knows.'); return; } }
    const size = phaseIdx===0?'50%': phaseIdx===1?'80%':'30%';
    c.querySelector('#sighCircle').style.width = size;
    c.querySelector('#sighCircle').style.height = size;
    c.querySelector('#sighText').innerText = phases[phaseIdx];
    c.querySelector('#sighCount').innerText = `${S.kids?'Round':'Breath'} ${round+1} of ${total}`;
    const dur = durations[phaseIdx]; phaseIdx++;
    S.timers.push(setTimeout(nextPhase, dur));
  }
  c.innerHTML = `<div class="tool-step" style="text-align:center">
    <p class="tool-sub" style="margin-bottom:24px">${S.kids?'Two quick sniffs in, then one long breath all the way out.':'Double inhale through the nose, then a full exhale through the mouth.'}</p>
    <div style="display:flex;align-items:center;justify-content:center;height:160px;margin-bottom:16px">
      <div id="sighCircle" style="width:50%;height:50%;border-radius:50%;background:var(--em-c);opacity:0.7;transition:all 1.2s ease-in-out;box-shadow:0 0 40px var(--em-g)"></div>
    </div>
    <p id="sighText" style="font-family:var(--font-d);font-size:1.25rem;font-weight:600;margin-bottom:8px">${phases[0]}</p>
    <p id="sighCount" style="color:var(--muted);font-size:0.85rem">${S.kids?'Round':'Breath'} 1 of ${total}</p>
  </div>`;
  S.timers.push(setTimeout(nextPhase, 300));
}

// ── STOP Practice ──
function renderStopPractice(c){
  const steps = S.kids
    ? [{l:'S',t:'Stop.',d:'Press pause on whatever you\'re doing right now.'},{l:'T',t:'Take a breath.',d:'One breath in through your nose, out through your mouth.'},{l:'O',t:'Observe.',d:'What\'s happening inside? Any feelings, thoughts, or body sensations?'},{l:'P',t:'Proceed.',d:'Now choose what to do next — on purpose, not by habit.'}]
    : [{l:'S',t:'Stop.',d:'Press pause right now. Interrupt whatever you\'re doing.'},{l:'T',t:'Take a breath.',d:'One slow, deliberate breath — in through the nose, out through the mouth.'},{l:'O',t:'Observe.',d:'What are you thinking? What are you feeling? What\'s happening in your body?'},{l:'P',t:'Proceed.',d:'Now choose your next action deliberately — not on autopilot.'}];
  let step = 0;
  function show(){
    if(step>=steps.length){ showComplete(c, S.kids?'That gap is where your choices live — nice work!':'That gap between stimulus and response is where your choices live.'); return; }
    const s = steps[step];
    c.innerHTML = `<div class="tool-step" style="text-align:center;animation:scaleIn 0.3s ease-out">
      <div style="width:72px;height:72px;border-radius:50%;background:var(--em-c);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-family:var(--font-d);font-size:2rem;font-weight:700;box-shadow:0 8px 24px var(--em-g)">${s.l}</div>
      <p style="font-family:var(--font-d);font-size:1.5rem;font-weight:600;margin-bottom:10px">${s.t}</p>
      <p style="color:var(--text2);font-size:0.9375rem;max-width:300px;margin:0 auto 28px">${s.d}</p>
      <p style="color:var(--muted);font-size:0.8rem;margin-bottom:14px">${step+1} of ${steps.length}</p>
      <button class="btn btn-em" onclick="(${() => { step++; show(); }}).call()">${step>=steps.length-1?(S.kids?'Done!':'Complete'):(S.kids?'Next →':'Next →')}</button>
    </div>`;
    c.querySelector('.btn-em').onclick = () => { step++; show(); };
  }
  show();
}

// ── Belly Breathing ──
function renderBellyBreath(c){
  let round = 0; const total = 5;
  const phases = [[S.kids?'Belly out!':'Belly out — inhale',4000],[S.kids?'Hold...':'Hold',1000],[S.kids?'Belly in...':'Belly in — exhale',6000]];
  let phaseIdx = 0;
  function nextPhase(){
    if(phaseIdx>=3){ phaseIdx=0; round++; if(round>=total){ showComplete(c, S.kids?'That\'s belly breathing — your body\'s calm switch!':'Exhaling longer than you inhale activates the calming branch of your nervous system.'); return; } }
    const scale = phaseIdx===0?'scale(1.3)': phaseIdx===1?'scale(1.3)':'scale(0.85)';
    c.querySelector('#bellyCircle').style.transform = scale;
    c.querySelector('#bellyPhase').innerText = phases[phaseIdx][0];
    c.querySelector('#bellyCount').innerText = `${S.kids?'Breath':'Breath'} ${round+1} of ${total}`;
    S.timers.push(setTimeout(nextPhase, phases[phaseIdx][1]));
    phaseIdx++;
  }
  c.innerHTML = `<div class="tool-step" style="text-align:center">
    <p class="tool-sub" style="margin-bottom:24px">${S.kids?'Make your tummy go out when you breathe in, and in when you breathe out.':'Breathe deep into your belly — not your chest. Let the exhale be twice as long as the inhale.'}</p>
    <div style="height:140px;display:flex;align-items:center;justify-content:center;margin-bottom:20px">
      <div id="bellyCircle" style="width:100px;height:100px;border-radius:50%;background:var(--em-c);opacity:0.75;transition:transform 1.5s ease-in-out;box-shadow:0 0 32px var(--em-g)"></div>
    </div>
    <p id="bellyPhase" style="font-family:var(--font-d);font-size:1.2rem;font-weight:600;margin-bottom:8px">Get ready...</p>
    <p id="bellyCount" style="color:var(--muted);font-size:0.85rem">Breath 1 of ${total}</p>
  </div>`;
  S.timers.push(setTimeout(nextPhase, 500));
}

// ── Half-Smile & Willing Hands ──
function renderHalfSmile(c){
  let step = 0;
  const steps = [
    {title:S.kids?'Soft face':'Lips', icon:'🙂', inst:S.kids?'Gently turn the corners of your mouth up — just a tiny bit. Not a full smile, just a hint of one.':'Gently lift the corners of your mouth — not a full smile, just the suggestion of one. Hold it softly.', dur:30},
    {title:S.kids?'Open hands':'Hands', icon:'🤲', inst:S.kids?'Open your palms and rest them face-up on your knees. Let your fingers go soft.':'Open your palms and turn them upward, resting them on your knees. Let your fingers soften.', dur:30}
  ];
  let timer = null;
  function showStep(){
    if(step>=steps.length){ showComplete(c, S.kids?'This is what calm looks like — your body knows it!':'This posture signals acceptance to your nervous system.'); return; }
    const s = steps[step]; let remaining = s.dur;
    const render = () => {
      c.innerHTML = `<div class="tool-step" style="text-align:center">
        <p style="color:var(--muted);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px">${step+1} of ${steps.length}</p>
        <div style="font-size:3rem;margin-bottom:14px">${s.icon}</div>
        <p style="font-family:var(--font-d);font-size:1.25rem;font-weight:600;margin-bottom:12px">${s.title}</p>
        <p style="color:var(--text2);font-size:0.9375rem;max-width:280px;margin:0 auto 20px">${s.inst}</p>
        <p style="font-size:2rem;font-weight:700;font-family:var(--font-d);color:var(--em-l);margin-bottom:6px">${remaining}</p>
        <p style="color:var(--muted);font-size:0.8rem">seconds</p>
      </div>`;
    };
    render();
    timer = setInterval(() => { remaining--; if(remaining<=0){ clearInterval(timer); step++; showStep(); } else { c.querySelector('p:nth-child(6)').innerText=remaining; } }, 1000);
    S.timers.push(timer);
  }
  showStep();
}

// ── 5-Finger Breathing ──
function renderFiveFingerBreath(c){
  let finger = 0; const total = 5; let going = true;
  const fingerNames = S.kids?['Thumb','Pointer','Middle','Ring','Pinky']:['Thumb','Index','Middle','Ring','Little'];
  function nextFinger(){
    if(!going) return;
    if(finger>=total){ showComplete(c, S.kids?'Five whole breaths — your body is calmer now!':'Five complete breath cycles. Notice any shift.'); return; }
    const up = [S.kids?'Breathe in...':'Inhale...', 2000];
    const dn = [S.kids?'Breathe out...':'Exhale...', 2000];
    c.querySelector('#ffPhase').innerText = `${fingerNames[finger]} — ${up[0]}`;
    c.querySelector('#ffCount').innerText = `Finger ${finger+1} of ${total}`;
    S.timers.push(setTimeout(() => {
      if(!going) return;
      c.querySelector('#ffPhase').innerText = `${fingerNames[finger]} — ${dn[0]}`;
      S.timers.push(setTimeout(() => { if(!going) return; finger++; nextFinger(); }, dn[1]));
    }, up[1]));
  }
  c.innerHTML = `<div class="tool-step" style="text-align:center">
    <p class="tool-sub" style="margin-bottom:20px">${S.kids?'Breathe in for each finger going up, breathe out for each finger going down.':'One breath per finger — inhale up, exhale down.'}</p>
    <div style="font-size:5rem;margin:16px 0">&#9995;</div>
    <p id="ffPhase" style="font-family:var(--font-d);font-size:1.2rem;font-weight:600;margin-bottom:8px">Get ready...</p>
    <p id="ffCount" style="color:var(--muted);font-size:0.85rem">Finger 1 of ${total}</p>
  </div>`;
  S.timers.push(setTimeout(nextFinger, 600));
}

// ── Emotion Labelling ──
function renderEmotionLabel(c){
  let step = 0; let userWord = '';
  function show(){
    if(step===0){
      c.innerHTML = `<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.1rem;font-weight:600;margin-bottom:8px">${S.kids?'What\'s the feeling called?':'What word best describes what you\'re feeling right now?'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:16px">${S.kids?'Try to put a name to it — any word is fine.':'Don\'t overthink it — just name it.'}</p>
        <textarea class="tool-input" id="elWord" placeholder="${S.kids?'e.g. scared, mad, worried...':'e.g. anxious, disappointed, irritable...'}" style="min-height:70px"></textarea>
        <button class="btn btn-em" style="margin-top:14px" onclick="(function(){const v=document.getElementById('elWord').value.trim();if(!v)return;window._elWord=v;step2()})()">→</button>
      </div>`;
      c.querySelector('.btn-em').onclick = () => { userWord=document.getElementById('elWord').value.trim(); if(!userWord) return; step=1; show(); };
    } else if(step===1){
      const refinements = {'anxious':['apprehensive','dread','foreboding','unease'],'angry':['frustrated','resentful','irritated','furious'],'sad':['disappointed','grief','blue','melancholy'],'scared':['nervous','terrified','uneasy','panicked'],'worried':['anxious','stressed','overwhelmed','tense']};
      const key = Object.keys(refinements).find(k => userWord.toLowerCase().includes(k));
      const opts = key ? refinements[key] : ['uncertain','uneasy','tense','distressed'];
      c.innerHTML = `<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.5rem;font-weight:600;color:var(--em-l);text-align:center;margin-bottom:6px">"${userWord}"</p>
        <p style="color:var(--text2);font-size:0.875rem;text-align:center;margin-bottom:18px">${S.kids?'Can you get even more specific?':'Now go further — can you be more specific?'}</p>
        <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:18px">
          ${opts.map(o=>`<button class="sym-pill" onclick="window._elFinal='${o}';elDone()">${o}</button>`).join('')}
          <button class="sym-pill" onclick="elAsk()">other...</button>
        </div>
      </div>`;
      window.elDone = () => { step=2; show(); };
      window.elAsk = () => { step=0; userWord=''; show(); };
    } else {
      const finalWord = window._elFinal || userWord;
      c.innerHTML = `<div class="tool-step" style="text-align:center">
        <p style="font-family:var(--font-d);font-size:1.8rem;font-weight:600;color:var(--em-l);margin-bottom:16px">"${finalWord}"</p>
        <p style="color:var(--text2);font-size:0.875rem;max-width:300px;margin:0 auto 24px">${S.kids?'You named it! That\'s the trick — giving your feeling a name makes your brain calm down a little bit.':'Naming an emotion precisely reduces the brain\'s alarm signal. The same region that fires up with strong emotion becomes quieter when you label it accurately.'}</p>
        <button class="btn btn-em" onclick="showComplete(document.getElementById('toolContent'), S.kids?\'Name it to tame it — you\'ve got the skill now!\':\'Name it to tame it — now you know exactly what you\'re working with.\')">${S.kids?'Got it!':'Done'}</button>
      </div>`;
    }
  }
  show();
}

// ── Urge Surfing ──
function renderUrgeSurf(c){
  let step = 0; let urgeText = ''; let bodyPart = '';
  const bodyParts = S.kids?['head','chest','tummy','hands','legs','all over']:['head','chest','stomach','hands','arms/legs','all over'];
  function show(){
    if(step===0){
      c.innerHTML = `<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?'What does the feeling want you to do?':'What urge is this emotion creating?'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:14px">${S.kids?'Write it down — you don\'t have to do it!':'Notice the impulse without acting on it.'}</p>
        <textarea class="tool-input" id="urgeTxt" placeholder="${S.kids?'e.g. run away, yell, hide...':'e.g. avoid, argue, shut down, eat...'}" style="min-height:70px"></textarea>
        <button class="btn btn-em" style="margin-top:14px">Next →</button>
      </div>`;
      c.querySelector('.btn-em').onclick = () => { urgeText=document.getElementById('urgeTxt').value.trim()||'the urge'; step=1; show(); };
    } else if(step===1){
      c.innerHTML = `<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:12px">${S.kids?'Where do you feel it in your body?':'Where is the urge strongest in your body?'}</p>
        <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">
          ${bodyParts.map(b=>`<button class="sym-pill" onclick="window._urgePart='${b}';step2bp()">${b}</button>`).join('')}
        </div>
      </div>`;
      window.step2bp = () => { bodyPart=window._urgePart; step=2; show(); };
    } else if(step===2){
      let secs = 60;
      c.innerHTML = `<div class="tool-step" style="text-align:center">
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:6px">${S.kids?'Don\'t do it — just watch it. Like a wave.':'Don\'t act on it. Just observe it.'}</p>
        <p style="font-family:var(--font-d);font-size:1rem;font-weight:600;color:var(--em-l);margin-bottom:20px">${S.kids?`The urge to ${urgeText} — watch it rise and fall`:`Notice: ${urgeText}`}</p>
        <div style="font-size:3.5rem;font-weight:700;font-family:var(--font-d);color:var(--em-c);margin-bottom:8px" id="urgeTimer">60</div>
        <p style="color:var(--muted);font-size:0.8rem;margin-bottom:12px">seconds — does it change?</p>
        <div style="height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin:0 20px"><div id="urgeBar" style="height:100%;width:100%;background:var(--em-c);border-radius:2px;transition:width 1s linear"></div></div>
      </div>`;
      const tick = setInterval(() => {
        secs--; const el = c.querySelector('#urgeTimer'), bar = c.querySelector('#urgeBar');
        if(el) el.innerText = secs; if(bar) bar.style.width = (secs/60*100)+'%';
        if(secs<=0){ clearInterval(tick); step=3; show(); }
      }, 1000);
      S.timers.push(tick);
    } else {
      showComplete(c, S.kids?'You just surfed that wave instead of being knocked over by it!':'You\'ve demonstrated that urges are impermanent. They peak and pass.');
    }
  }
  show();
}

// ── Self-Distancing ──
function renderSelfDistancing(c){
  let step = 0; let firstPerson = '';
  function show(){
    if(step===0){
      c.innerHTML = `<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?'Tell me what\'s going on using "I"':'Describe the situation using "I"'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:14px">${S.kids?'Write it how you\'d say it out loud.':'Write it as you\'re experiencing it right now.'}</p>
        <textarea class="tool-input" id="sdFirst" placeholder="${S.kids?'I feel... because...':'I feel... / I am worried about...'}" style="min-height:80px"></textarea>
        <button class="btn btn-em" style="margin-top:14px">Next →</button>
      </div>`;
      c.querySelector('.btn-em').onclick = () => { firstPerson=document.getElementById('sdFirst').value.trim(); if(!firstPerson) return; step=1; show(); };
    } else if(step===1){
      c.innerHTML = `<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?'Now say the same thing using your own name instead of "I"':'Now say the same thing, but refer to yourself by name'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:6px">${S.kids?'As if you\'re talking about your friend.':'e.g. If you wrote "I feel overwhelmed", write "[your name] feels overwhelmed"'}</p>
        <textarea class="tool-input" id="sdSecond" style="min-height:80px" placeholder="${S.kids?'[Your name] feels...':'[Your name] feels...'}">[Name] </textarea>
        <button class="btn btn-em" style="margin-top:14px">Next →</button>
      </div>`;
      c.querySelector('.btn-em').onclick = () => { step=2; show(); };
    } else {
      c.innerHTML = `<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?'How did that feel different?':'How did that feel different?'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:14px">${S.kids?'Did it feel a tiny bit less stuck?':'Did it create any distance? Any perspective?'}</p>
        <textarea class="tool-input" id="sdThird" placeholder="${S.kids?'It felt...':'It felt... / I noticed...'}" style="min-height:70px"></textarea>
        <button class="btn btn-em" style="margin-top:14px">${S.kids?'Done!':'Complete'}</button>
      </div>`;
      c.querySelector('.btn-em').onclick = () => showComplete(c, S.kids?'You just gave yourself a little breathing room — that\'s the skill!':'That shift activates the same neural circuits as giving advice to a friend — instant perspective.');
    }
  }
  show();
}

// ═══════════════════════════════════════════════════════════
// PHASE 9: NEW DEEP TOOL RENDERERS
// ═══════════════════════════════════════════════════════════

// ── Body Scan ──
function renderBodyScan(c){
  const regions = S.kids
    ? ['Head & scalp','Face & jaw','Neck & shoulders','Chest','Belly','Lower back & hips','Legs','Feet']
    : ['Head & scalp','Face & jaw','Neck & shoulders','Chest','Belly','Lower back & hips','Legs & knees','Feet & toes'];
  const inst = S.kids
    ? 'Move your attention here. Don\'t try to change anything — just notice what\'s there.'
    : 'Bring your attention here with curiosity, not judgement. Notice any sensation — or nothing at all.';
  let idx = 0; let secs = 20; let timer = null;
  function showRegion(){
    if(idx>=regions.length){ showComplete(c, S.kids?'Head to toe — you just checked in with your whole body!':'A complete body scan done. Radical non-judgemental awareness.'); return; }
    secs = 20;
    const dots = regions.map((_,i) => `<div style="width:8px;height:8px;border-radius:50%;background:${i===idx?'var(--em-c)':'rgba(255,255,255,0.15)'}"></div>`).join('');
    const render = () => {
      c.innerHTML = `<div class="tool-step" style="text-align:center">
        <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-bottom:24px">${dots}</div>
        <p style="color:var(--muted);font-size:0.8rem;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px">${idx+1} of ${regions.length}</p>
        <p style="font-family:var(--font-d);font-size:1.5rem;font-weight:600;margin-bottom:14px">${regions[idx]}</p>
        <p style="color:var(--text2);font-size:0.9rem;max-width:280px;margin:0 auto 24px">${inst}</p>
        <p style="font-size:2.5rem;font-weight:700;font-family:var(--font-d);color:var(--em-l)" id="bsTimer">${secs}</p>
        <button class="btn" style="margin-top:16px;background:rgba(255,255,255,0.06);font-size:0.85rem" id="bsNext">${S.kids?'Move on →':'Continue →'}</button>
      </div>`;
      c.querySelector('#bsNext').onclick = () => { clearInterval(timer); idx++; showRegion(); };
    };
    render();
    timer = setInterval(() => { secs--; const el=c.querySelector('#bsTimer'); if(el) el.innerText=secs; if(secs<=0){ clearInterval(timer); idx++; showRegion(); } }, 1000);
    S.timers.push(timer);
  }
  showRegion();
}

// ── Loving-Kindness ──
function renderLovingKindness(c){
  const stages = S.kids
    ? [{title:'You',sub:'Send warm wishes to yourself first'},{title:'Someone you love',sub:'Think of someone who makes you happy'},{title:'Someone you don\'t know',sub:'Like a neighbour or someone you passed today'},{title:'Everyone',sub:'Send warm wishes to all people everywhere'}]
    : [{title:'Yourself',sub:'Direct these wishes inward first'},{title:'A loved one',sub:'Someone whose wellbeing matters to you'},{title:'A neutral person',sub:'Someone you neither like nor dislike'},{title:'All beings',sub:'Expanding outward — all people, everywhere'}];
  const phrases = S.kids
    ? ['May you be safe.','May you be healthy.','May you be happy.']
    : ['May you be safe.','May you be healthy.','May you live with ease.'];
  let stageIdx=0, phraseIdx=0;
  function showPhrase(){
    if(phraseIdx>=phrases.length){ stageIdx++; phraseIdx=0; if(stageIdx>=stages.length){ showComplete(c, S.kids?'Warm wishes sent — to you and everyone!':'Loving-kindness practice expands compassion in all directions, including back toward yourself.'); return; } }
    const st = stages[stageIdx];
    c.innerHTML = `<div class="tool-step" style="text-align:center">
      <div style="display:flex;gap:6px;justify-content:center;margin-bottom:20px">${stages.map((_,i)=>`<div style="width:8px;height:8px;border-radius:50%;background:${i===stageIdx?'var(--em-c)':'rgba(255,255,255,0.15)'}"></div>`).join('')}</div>
      <p style="color:var(--muted);font-size:0.8rem;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px">${st.sub}</p>
      <p style="font-family:var(--font-d);font-size:1.5rem;font-weight:600;margin-bottom:24px">${st.title}</p>
      <p style="font-family:var(--font-d);font-size:1.2rem;color:var(--em-l);animation:fadeUp 0.4s ease-out;margin-bottom:28px">${phrases[phraseIdx]}</p>
      <button class="btn btn-em" id="lkNext">${phraseIdx>=phrases.length-1&&stageIdx>=stages.length-1?(S.kids?'Done!':'Complete'):(S.kids?'Next →':'Next →')}</button>
    </div>`;
    c.querySelector('#lkNext').onclick = () => { phraseIdx++; showPhrase(); };
  }
  showPhrase();
}

// ── RAIN Practice ──
function renderRainPractice(c){
  const steps = S.kids
    ? [{l:'R',t:'Recognise',q:'What feeling is here right now?',p:'Name it — any word is fine.',type:'text'},{l:'A',t:'Allow',q:'Let it be here for a moment.',p:'You don\'t have to fix it or make it go away — just let it be.',type:'pause',dur:30},{l:'I',t:'Investigate',q:'Where do you feel it in your body? What does it need?',p:'Be curious, not critical.',type:'text'},{l:'N',t:'Nurture',q:'What kind thing could you say to yourself right now?',p:'"This is hard. I\'m doing my best."',type:'text'}]
    : [{l:'R',t:'Recognise',q:'What emotion is here?',p:'Name it as precisely as you can.',type:'text'},{l:'A',t:'Allow',q:'Let it be here without trying to change it.',p:'You don\'t have to like it. Just stop fighting it for 30 seconds.',type:'pause',dur:30},{l:'I',t:'Investigate',q:'Where do you feel it in your body? What does it need?',p:'Two questions — answer either or both.',type:'text'},{l:'N',t:'Nurture',q:'What compassionate response can you offer yourself?',p:'What would you say to a friend in the same situation?',type:'text'}];
  let idx=0;
  function show(){
    if(idx>=steps.length){ showComplete(c, S.kids?'Four steps, four steps closer to feeling better!':'RAIN turns self-judgement into self-inquiry — that\'s the transformation.'); return; }
    const s=steps[idx];
    if(s.type==='pause'){
      let secs=s.dur;
      const render=()=>{
        c.innerHTML=`<div class="tool-step" style="text-align:center">
          <div style="width:56px;height:56px;border-radius:50%;background:var(--em-c);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-family:var(--font-d);font-size:1.5rem;font-weight:700">${s.l}</div>
          <p style="font-family:var(--font-d);font-size:1.3rem;font-weight:600;margin-bottom:8px">${s.t}</p>
          <p style="color:var(--text2);font-size:0.9rem;max-width:280px;margin:0 auto 20px">${s.p}</p>
          <p style="font-size:2.5rem;font-weight:700;font-family:var(--font-d);color:var(--em-l)" id="rainTimer">${secs}</p>
          <button class="btn" style="margin-top:16px;background:rgba(255,255,255,0.06);font-size:0.85rem" id="rainSkip">${S.kids?'I\'m ready →':'Continue →'}</button>
        </div>`;
        c.querySelector('#rainSkip').onclick=()=>{clearInterval(t);idx++;show();};
      };
      render();
      const t=setInterval(()=>{secs--;const el=c.querySelector('#rainTimer');if(el)el.innerText=secs;if(secs<=0){clearInterval(t);idx++;show();}},1000);
      S.timers.push(t);
    } else {
      c.innerHTML=`<div class="tool-step">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
          <div style="width:48px;height:48px;border-radius:50%;background:var(--em-c);display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-size:1.3rem;font-weight:700;flex-shrink:0">${s.l}</div>
          <div><p style="font-family:var(--font-d);font-size:1.1rem;font-weight:600">${s.t}</p><p style="color:var(--muted);font-size:0.8rem">${s.p}</p></div>
        </div>
        <p style="color:var(--text2);font-size:0.9rem;margin-bottom:12px">${s.q}</p>
        <textarea class="tool-input" id="rainInput" style="min-height:80px"></textarea>
        <button class="btn btn-em" style="margin-top:14px">${idx>=steps.length-1?(S.kids?'Done!':'Complete'):'Next →'}</button>
      </div>`;
      c.querySelector('.btn-em').onclick=()=>{idx++;show();};
    }
  }
  show();
}

// ── Safe Place Visualisation ──
function renderSafePlace(c){
  const qs = S.kids
    ? ['Where is your peaceful place? (real or made up)','What do you see there?','What sounds are there — or is it quiet?','What does the air feel like?','What makes it feel safe?']
    : ['Where is your safe place? (real or imagined)','What do you see there?','What sounds are there, or is it quiet?','What does the air feel like on your skin?','What makes this place feel safe?'];
  let idx=0;
  function show(){
    if(idx>=qs.length){
      let secs=30;
      c.innerHTML=`<div class="tool-step" style="text-align:center">
        <div style="font-size:3rem;margin-bottom:14px">&#127968;</div>
        <p style="font-family:var(--font-d);font-size:1.1rem;font-weight:600;margin-bottom:8px">${S.kids?'Close your eyes...':'Close your eyes if comfortable'}</p>
        <p style="color:var(--text2);font-size:0.875rem;max-width:280px;margin:0 auto 20px">${S.kids?'Hold your peaceful place in your mind for 30 seconds.':'Hold this place in your mind. Let it become vivid and real.'}</p>
        <p style="font-size:2.5rem;font-weight:700;font-family:var(--font-d);color:var(--em-l)" id="spTimer">30</p>
      </div>`;
      const t=setInterval(()=>{secs--;const el=c.querySelector('#spTimer');if(el)el.innerText=secs;if(secs<=0){clearInterval(t);showComplete(c,S.kids?'Your peaceful place is always there — you built it!':'The more you return here, the more vivid and accessible it becomes.');}},1000);
      S.timers.push(t);
      return;
    }
    c.innerHTML=`<div class="tool-step">
      <p style="color:var(--muted);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px">${idx+1} of ${qs.length}</p>
      <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:14px">${qs[idx]}</p>
      <textarea class="tool-input" style="min-height:80px"></textarea>
      <button class="btn btn-em" style="margin-top:14px">${idx>=qs.length-1?(S.kids?'Close my eyes →':'Begin visualisation →'):'Next →'}</button>
    </div>`;
    c.querySelector('.btn-em').onclick=()=>{idx++;show();};
  }
  show();
}

// ── Compassionate Letter ──
function renderCompassionLetter(c){
  const steps = S.kids
    ? [{q:'What\'s been hard lately?',p:'Tell it like you\'re telling a good friend.',ph:'Something that happened, or a feeling that\'s been around...'},{q:'Now imagine your kindest friend is writing you a letter.',p:'They love you and totally understand. What would they write?',ph:'Dear ...,\n\n'},{q:'Read it back. What\'s the most important thing they said?',p:'Just one thing.',ph:'They want me to know that...'}]
    : [{q:'What\'s been hard lately?',p:'Write it briefly — as if telling a trusted friend.',ph:'Describe the situation or feeling...'},{q:'Now imagine the wisest, most compassionate person you know is writing you a letter.',p:'They fully understand your situation and love you unconditionally. Begin: "Dear [your name]..."',ph:'Dear ...,\n\n'},{q:'Read it back. What one thing do they most want you to know?',p:'Distil it to a single sentence.',ph:'They want me to know that...'}];
  let idx=0;
  function show(){
    if(idx>=steps.length){ showComplete(c, S.kids?'That kindness you wrote — it\'s already inside you!':'The compassion you extended there is always available to you. You wrote it, which means it already exists within you.'); return; }
    const s=steps[idx];
    c.innerHTML=`<div class="tool-step">
      <p style="color:var(--muted);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px">${idx+1} of ${steps.length}</p>
      <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:6px">${s.q}</p>
      <p style="color:var(--text2);font-size:0.875rem;margin-bottom:14px">${s.p}</p>
      <textarea class="tool-input" style="min-height:${idx===1?'140px':'90px'}" placeholder="${s.ph}"></textarea>
      <button class="btn btn-em" style="margin-top:14px">${idx>=steps.length-1?(S.kids?'Done!':'Complete'):'Next →'}</button>
    </div>`;
    c.querySelector('.btn-em').onclick=()=>{idx++;show();};
  }
  show();
}

// ── Expressive Writing ──
function renderExpressiveWrite(c){
  const qs = S.kids
    ? ['What happened, and what feelings came up?','Why do you think you feel this way? Go deeper — what does it touch?','What would you like to let go of? What do you want to hold onto?']
    : ['What happened, and what feelings came up?','Why do you think you feel this way? What does this situation touch in you?','What would you like to let go of? What do you want to hold onto?'];
  let idx=0;
  function show(){
    if(idx>=qs.length){ showComplete(c, S.kids?'You did it — getting feelings out on paper is one of the bravest things you can do.':'Expressive writing measurably reduces distress over the days that follow. The processing has begun.'); return; }
    c.innerHTML=`<div class="tool-step">
      <p style="color:var(--muted);font-size:0.75rem;margin-bottom:10px">${S.kids?'🔒 Private — no one sees this':'Private — this is for your eyes only'}</p>
      <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:14px">${qs[idx]}</p>
      <textarea class="tool-input" style="min-height:130px" placeholder="${S.kids?'Write anything — messy is fine!':'Write honestly — no editing, no filtering.'}"></textarea>
      <button class="btn btn-em" style="margin-top:14px">${idx>=qs.length-1?(S.kids?'All done!':'Complete'):'Next →'}</button>
    </div>`;
    c.querySelector('.btn-em').onclick=()=>{idx++;show();};
  }
  show();
}

// ── Worry Window ──
function renderWorryWindow(c){
  let step=0; let chosenTime='';
  const times = S.kids?['Morning','Lunchtime','After school','Evening']:['Morning','Lunchtime','Afternoon','Evening'];
  function show(){
    if(step===0){
      c.innerHTML=`<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?'Brain dump — write down everything that\'s worrying you.':'Brain dump — write every worry on your mind right now.'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:14px">${S.kids?'Get them all out — big ones, tiny ones, silly ones.':'Don\'t filter. Speed-write. Get them out of your head.'}</p>
        <textarea class="tool-input" style="min-height:130px" placeholder="${S.kids?'My worries right now are...':'Every worry I\'m carrying right now...'}"></textarea>
        <button class="btn btn-em" style="margin-top:14px">Next →</button>
      </div>`;
      c.querySelector('.btn-em').onclick=()=>{step=1;show();};
    } else if(step===1){
      c.innerHTML=`<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?'Pick a Worry Time — when can you deal with them?':'Choose your Worry Window — a daily 15-minute slot.'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:16px">${S.kids?'Outside that time, when a worry arrives, say "not now — I\'ll think about you at Worry Time".':'When a worry arrives outside this window, postpone it — don\'t suppress it.'}</p>
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
          ${times.map(t=>`<button class="sym-pill" onclick="window._wwTime='${t}';wwNext()">${t}</button>`).join('')}
        </div>
      </div>`;
      window.wwNext=()=>{chosenTime=window._wwTime;step=2;show();};
    } else {
      showComplete(c, S.kids?`Your Worry Time is ${chosenTime}. When a worry arrives early, say: "Not now — ${chosenTime} is your time!"`:`Your Worry Window is ${chosenTime}. When worries arrive before then: "Not now — I'll address you at ${chosenTime}." You\'re containing worry, not suppressing it.`);
    }
  }
  show();
}

// ── Pleasant Events Scheduling ──
function renderPleasantEvents(c){
  let step=0; const activities=[]; let ratings=[];
  function show(){
    if(step===0){
      const fields=[1,2,3,4,5].map(i=>`<input class="tool-input" id="pe${i}" placeholder="Activity ${i}" style="min-height:0;padding:10px 14px;margin-bottom:8px" type="text">`).join('');
      c.innerHTML=`<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?'List 5 things you enjoy — even small ones!':'List 5 activities that give you pleasure or meaning.'}</p>
        <p style="color:var(--text2);font-size:0.875rem;margin-bottom:14px">${S.kids?'Big or tiny — they all count.':'Even small, simple things count.'}</p>
        ${fields}
        <button class="btn btn-em" style="margin-top:6px">Next →</button>
      </div>`;
      c.querySelector('.btn-em').onclick=()=>{
        activities.length=0;
        [1,2,3,4,5].forEach(i=>{const v=document.getElementById('pe'+i).value.trim();if(v)activities.push(v);});
        if(!activities.length)return; ratings=activities.map(()=>0); step=1; show();
      };
    } else if(step===1){
      c.innerHTML=`<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:14px">${S.kids?'How much are you looking forward to each one? (1–5)':'Rate how much you\'re looking forward to each (1–5).'}</p>
        ${activities.map((a,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:0.9rem;color:var(--text2);flex:1;margin-right:10px">${a}</span>
          <div style="display:flex;gap:4px">${[1,2,3,4,5].map(n=>`<button class="reflect-dot" id="pe_${i}_${n}" onclick="window._peRatings[${i}]=${n};peHighlight(${i},${n})" style="width:36px;height:36px;font-size:0.85rem">${n}</button>`).join('')}</div>
        </div>`).join('')}
        <button class="btn btn-em" style="margin-top:16px">Next →</button>
      </div>`;
      window._peRatings = [...ratings];
      window.peHighlight = (i,n) => {
        [1,2,3,4,5].forEach(x=>{const d=document.getElementById(`pe_${i}_${x}`);if(d)d.classList.toggle('sel',x===n);});
      };
      c.querySelector('.btn-em').onclick=()=>{ratings=window._peRatings;step=2;show();};
    } else {
      const best = activities.reduce((bi,_,i)=>window._peRatings[i]>window._peRatings[bi]?i:bi, 0);
      c.innerHTML=`<div class="tool-step">
        <p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600;margin-bottom:8px">${S.kids?`Pick one to do this week — when exactly?`:`Schedule one for this week. Be specific.`}</p>
        <p style="color:var(--em-l);font-size:0.9rem;margin-bottom:14px">${S.kids?'Your top pick:':'Highest rated:'} <strong>${activities[best]}</strong></p>
        <input class="tool-input" id="peWhen" placeholder="${S.kids?'e.g. Saturday after lunch':'e.g. Tuesday evening after dinner'}" style="min-height:0;padding:10px 14px" type="text">
        <button class="btn btn-em" style="margin-top:14px">${S.kids?'It\'s happening!':'Schedule it'}</button>
      </div>`;
      c.querySelector('.btn-em').onclick=()=>showComplete(c, S.kids?'That appointment with yourself is real now — protect it!':'That appointment with yourself is as real as any other. Protect it.');
    }
  }
  show();
}

// ── Thought Record ──
function renderThoughtRecord(c){
  const steps = S.kids
    ? [{l:'A',t:'What happened?',p:'Just the facts — like a detective.',ph:'What actually happened, with no extra story...'},{l:'B',t:'What did your brain say?',p:'What thought popped up automatically?',ph:'My brain said...'},{l:'C',t:'How did that make you feel?',p:'And how big was the feeling (0–10)?',ph:'I felt... (0–10)'},{l:'D',t:'Is there another way to see it?',p:'What would you tell your best friend in the same situation?',ph:'Another way to look at it is...'},{l:'E',t:'What\'s more true and balanced?',p:'A thought that\'s fair to yourself.',ph:'A more balanced thought is...'}]
    : [{l:'A',t:'Activating event',p:'What happened? Facts only — no interpretation.',ph:'Describe the situation objectively...'},{l:'B',t:'Automatic thought',p:'What did your mind tell you this means?',ph:'The thought that arose was...'},{l:'C',t:'Consequences',p:'What emotion(s) did you feel? Intensity 0–100?',ph:'I felt... at intensity...'},{l:'D',t:'Dispute',p:'Evidence for the thought? Against it? What would you say to a friend?',ph:'Evidence for... Evidence against...'},{l:'E',t:'Effective belief',p:'A more balanced, accurate way to see this.',ph:'A more balanced view is...'}];
  let idx=0;
  function show(){
    if(idx>=steps.length){ showComplete(c, S.kids?'Detective work done — you just looked at the facts!':'The core exercise of cognitive therapy. With practice, disputing becomes automatic.'); return; }
    const s=steps[idx];
    c.innerHTML=`<div class="tool-step">
      <div style="display:flex;gap:8px;margin-bottom:16px">${steps.map((_,i)=>`<div style="width:8px;height:8px;border-radius:50%;background:${i===idx?'var(--em-c)':'rgba(255,255,255,0.15)'}"></div>`).join('')}</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="width:40px;height:40px;border-radius:50%;background:var(--em-c);display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-size:1.1rem;font-weight:700;flex-shrink:0">${s.l}</div>
        <div><p style="font-family:var(--font-d);font-size:1.05rem;font-weight:600">${s.t}</p><p style="color:var(--muted);font-size:0.8rem">${s.p}</p></div>
      </div>
      <textarea class="tool-input" style="min-height:${idx===3?'110px':'80px'}" placeholder="${s.ph}"></textarea>
      <button class="btn btn-em" style="margin-top:14px">${idx>=steps.length-1?(S.kids?'Done!':'Complete'):'Next →'}</button>
    </div>`;
    c.querySelector('.btn-em').onclick=()=>{idx++;show();};
  }
  show();
}

// ── Mountain Meditation ──
function renderMountainMeditation(c){
  const phases = S.kids
    ? [{text:'Imagine a big, solid mountain. It\'s been there forever. Picture its shape, its rocks, its peak reaching up into the sky.',dur:35},{text:'Now imagine YOU are the mountain. Snow falls on you. Storms blow through. Sun blazes down. But through all of it — you stay.',dur:40},{text:'Your feelings are like the weather. They move through you. Big storms come and go. But you — the mountain — are always still and solid underneath.',dur:40}]
    : [{text:'Imagine a great mountain — ancient, solid, immovable. Picture it in full detail: its shape, the rock face, the peak cutting through sky.',dur:35},{text:'Now sense yourself as the mountain. Seasons change. Snow falls, storms rage, sun blazes. Through all of it, the mountain remains still.',dur:40},{text:'Your emotions are the weather. They move through you. You are not the weather. You are the mountain.',dur:40}];
  let idx=0;
  function showPhase(){
    if(idx>=phases.length){ showComplete(c, S.kids?'You are the mountain. Storms pass, but you stay solid.':'However you feel right now, you have a stable centre. Storms pass.'); return; }
    const ph=phases[idx]; let secs=ph.dur;
    c.innerHTML=`<div class="tool-step" style="text-align:center">
      <div style="font-size:3rem;margin-bottom:16px">&#9968;</div>
      <p style="font-family:var(--font-d);font-size:1.1rem;line-height:1.6;color:var(--text2);max-width:300px;margin:0 auto 28px;animation:fadeUp 0.5s ease-out">${ph.text}</p>
      <svg width="48" height="48" viewBox="0 0 48 48" style="transform:rotate(-90deg)">
        <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
        <circle id="mmArc" cx="24" cy="24" r="20" fill="none" stroke="var(--em-c)" stroke-width="3" stroke-dasharray="125.6" stroke-dashoffset="0" style="transition:stroke-dashoffset 1s linear"/>
      </svg>
      <p style="color:var(--muted);font-size:0.8rem;margin-top:8px" id="mmSecs">${secs}s</p>
    </div>`;
    const full=125.6;
    const t=setInterval(()=>{
      secs--; const arc=c.querySelector('#mmArc'),el=c.querySelector('#mmSecs');
      if(arc) arc.style.strokeDashoffset=(full*(1-secs/ph.dur)).toFixed(1);
      if(el) el.innerText=secs+'s';
      if(secs<=0){clearInterval(t);idx++;showPhase();}
    },1000);
    S.timers.push(t);
  }
  showPhase();
}

// ── Completion Screen ──
function showComplete(container, message){
  window._reflectRating = null;
  const scaleEmoji = ['😞','😐','🙂','😊','🌟'];
  const dots = [1,2,3,4,5].map(n => `
    <button class="reflect-dot" onclick="selectRating(${n})" aria-pressed="false" aria-label="Rate ${n} out of 5">
      <span>${scaleEmoji[n-1]}</span>
      <span class="reflect-dot-num">${n}</span>
    </button>`).join('');
  container.innerHTML = `<div class="complete-wrap">
    <div class="complete-check">&#10003;</div>
    <p class="complete-title">${S.kids ? 'Amazing!' : 'Well done'}</p>
    <p class="complete-sub">${message}</p>
    <div class="reflect-wrap">
      <p class="reflect-q">${S.kids ? 'Did this help?' : 'How effective was this for you?'}</p>
      <div class="reflect-scale">${dots}</div>
      <textarea class="reflect-note" id="reflectNote" placeholder="${S.kids ? 'Anything else on your mind? (optional)' : 'Any notes for yourself? (optional)'}" rows="3"></textarea>
      <div class="reflect-actions">
        <button class="btn btn-em" onclick="saveAndClose()">${S.kids ? 'Save it!' : 'Save &amp; close'}</button>
        <button class="reflect-skip" onclick="skipReflection()">${S.kids ? 'No thanks' : 'Skip'}</button>
      </div>
    </div>
  </div>`;
}

window.selectRating = (n) => {
  window._reflectRating = n;
  document.querySelectorAll('.reflect-dot').forEach((d, i) => {
    const sel = i + 1 === n;
    d.classList.toggle('sel', sel);
    d.setAttribute('aria-pressed', String(sel));
  });
};

window.saveAndClose = () => {
  const note = (document.getElementById('reflectNote') || {}).value || '';
  saveReflection(S.currentTool, window._reflectRating, note);
  window._reflectRating = null;
  closeTool();
};

window.skipReflection = () => {
  saveReflection(S.currentTool, null, '');
  window._reflectRating = null;
  closeTool();
};

// ── Initialize ──
init();
</script>
</body>
</html>
